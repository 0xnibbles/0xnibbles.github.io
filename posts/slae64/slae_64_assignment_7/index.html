<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>SLAE64 Assignment 7 - Custom Crypter | nibbles</title>
<meta name="keywords" content="slae64">
<meta name="description" content="This post introduces the 7th and last mission of my SLAE64 journey.
As well as the SLAE32 - Custom Crypter decided to work with python3 and the majority of the work was dealing with conversion types between encrypting and decrypting the shellcode.
Introduction The SLAE32 7th assignment purpose is to create a custom crypter having as reference the one shown in the crypter lesson..
For this task there are no special requirements:">
<meta name="author" content="nibbles">
<link rel="canonical" href="https://0xnibbles.github.io/posts/slae64/slae_64_assignment_7/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css" integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://0xnibbles.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://0xnibbles.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://0xnibbles.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://0xnibbles.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://0xnibbles.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="SLAE64 Assignment 7 - Custom Crypter" />
<meta property="og:description" content="This post introduces the 7th and last mission of my SLAE64 journey.
As well as the SLAE32 - Custom Crypter decided to work with python3 and the majority of the work was dealing with conversion types between encrypting and decrypting the shellcode.
Introduction The SLAE32 7th assignment purpose is to create a custom crypter having as reference the one shown in the crypter lesson..
For this task there are no special requirements:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://0xnibbles.github.io/posts/slae64/slae_64_assignment_7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-02T00:27:36+00:00" />
<meta property="article:modified_time" content="2023-01-02T00:27:36+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SLAE64 Assignment 7 - Custom Crypter"/>
<meta name="twitter:description" content="This post introduces the 7th and last mission of my SLAE64 journey.
As well as the SLAE32 - Custom Crypter decided to work with python3 and the majority of the work was dealing with conversion types between encrypting and decrypting the shellcode.
Introduction The SLAE32 7th assignment purpose is to create a custom crypter having as reference the one shown in the crypter lesson..
For this task there are no special requirements:"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://0xnibbles.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "SLAE64 Assignment 7 - Custom Crypter",
      "item": "https://0xnibbles.github.io/posts/slae64/slae_64_assignment_7/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "SLAE64 Assignment 7 - Custom Crypter",
  "name": "SLAE64 Assignment 7 - Custom Crypter",
  "description": "This post introduces the 7th and last mission of my SLAE64 journey.\nAs well as the SLAE32 - Custom Crypter decided to work with python3 and the majority of the work was dealing with conversion types between encrypting and decrypting the shellcode.\nIntroduction The SLAE32 7th assignment purpose is to create a custom crypter having as reference the one shown in the crypter lesson..\nFor this task there are no special requirements:",
  "keywords": [
    "slae64"
  ],
  "articleBody": " This post introduces the 7th and last mission of my SLAE64 journey.\nAs well as the SLAE32 - Custom Crypter decided to work with python3 and the majority of the work was dealing with conversion types between encrypting and decrypting the shellcode.\nIntroduction The SLAE32 7th assignment purpose is to create a custom crypter having as reference the one shown in the crypter lesson..\nFor this task there are no special requirements:\nCan use any existing encryption schema Can use any programming language I decided to to have a simpler approach to this task and as well other previous assignments I tried to port the 32bit version to 64bit.\nThere is a lof of overlap information with my post regarding the SLAE32 - Custom Crypter if you are interested in compare the between the ISAs.\nCrypter For the encryption scheme, the choice was AES in CTR mode. I used the script made for the custom encoder/decoder assignment as a reference.\nFor the shellcode I used the execve stack shellcode\n\\x31\\xc0\\x50\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\x50\\x89\\xe2\\x53\\x89\\xe1\\xb0\\x0b\\xcd\\x80 Let’s see the crypter script.\n#!/usr/bin/python3 # AES CTR-mode shellcode crypter import argparse import secrets import sys import string import pyaes import binascii import os secretsGenerator = secrets.SystemRandom() c_style_shellcode = (b\"\\x48\\x31\\xc0\\x50\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x53\\x48\\x89\\xe7\\x50\\x48\\x89\\xe2\\x57\\x48\\x89\\xe6\\x48\\x83\\xc0\\x3b\\x0f\\x05\") # bin/sh shellcode = \"\\x48\\x31\\xc0\\x50\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x53\\x48\\x89\\xe7\\x50\\x48\\x89\\xe2\\x57\\x48\\x89\\xe6\\x48\\x83\\xc0\\x3b\\x0f\\x05\" encrypted_shellcode = \"\\x97\\x90\\xe1\\x60\\x56\\x70\\xfc\\x91\\x60\\x01\\xa2\\xcf\\x29\\x43\\x67\\x15\\x9f\\x73\\x72\\x9b\\xff\\x25\\xb8\\xfa\\xe9\\xc8\\xa6\\x3f\\xe8\\x0d\\x9e\\xa9\" # encrypted shellcode iv =86225370279291231266238124133917033753321926857843067389263155507994576978348 def banner(): print(''' ________________________________________________________ ",
  "wordCount" : "740",
  "inLanguage": "en",
  "datePublished": "2023-01-02T00:27:36Z",
  "dateModified": "2023-01-02T00:27:36Z",
  "author":{
    "@type": "Person",
    "name": "nibbles"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://0xnibbles.github.io/posts/slae64/slae_64_assignment_7/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "nibbles",
    "logo": {
      "@type": "ImageObject",
      "url": "https://0xnibbles.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://0xnibbles.github.io/" accesskey="h" title="nibbles (Alt + H)">nibbles</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://0xnibbles.github.io/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/about.html" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://0xnibbles.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://0xnibbles.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      SLAE64 Assignment 7 - Custom Crypter
    </h1>
    <div class="post-meta"><span title='2023-01-02 00:27:36 +0000 UTC'>January 2, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;nibbles

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a><ul>
                        
                <li>
                    <a href="#crypter" aria-label="Crypter">Crypter</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><img loading="lazy" src="/slae64/slae64.png#center" alt="SLAE64"  title="SLAE64"  />
</p>
<p>This post introduces the 7th and last mission of my SLAE64 journey.</p>
<p>As well as the <a href="/posts/slae32/slae_32_assignment_7/">SLAE32 - Custom Crypter</a> decided to work with python3 and the majority of the work was dealing with conversion types between encrypting and decrypting the shellcode.</p>
<h1 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h1>
<p>The SLAE32 7th assignment purpose is to create a custom crypter having as reference the one shown in the crypter lesson..</p>
<p>For this task there are no special requirements:</p>
<ul>
<li>Can use any existing encryption schema</li>
<li>Can use any programming language</li>
</ul>
<p>I decided to to have a simpler approach to this task and as well other previous assignments I tried to port the 32bit version to 64bit.</p>
<p>There is a lof of overlap information with my post regarding the <a href="/posts/slae32/slae_32_assignment_7/">SLAE32 - Custom Crypter</a> if you are interested in compare the between the ISAs.</p>
<h2 id="crypter">Crypter<a hidden class="anchor" aria-hidden="true" href="#crypter">#</a></h2>
<p>For the encryption scheme, the choice was <code>AES</code> in <code>CTR mode</code>. I used the script made for the custom encoder/decoder assignment as a reference.</p>
<p>For the shellcode I used the <code>execve stack shellcode</code></p>
<pre tabindex="0"><code>\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80
</code></pre><p>Let&rsquo;s see the <code>crypter</code> script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AES CTR-mode shellcode crypter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> secrets
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pyaes
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> binascii
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>secretsGenerator <span style="color:#f92672">=</span> secrets<span style="color:#f92672">.</span>SystemRandom()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>c_style_shellcode <span style="color:#f92672">=</span> (<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x48\x31\xc0\x50\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x48\x89\xe7\x50\x48\x89\xe2\x57\x48\x89\xe6\x48\x83\xc0\x3b\x0f\x05</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e"># bin/sh</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x48\x31\xc0\x50\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x48\x89\xe7\x50\x48\x89\xe2\x57\x48\x89\xe6\x48\x83\xc0\x3b\x0f\x05</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>encrypted_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x97\x90\xe1\x60\x56\x70\xfc\x91\x60\x01\xa2\xcf\x29\x43\x67\x15\x9f\x73\x72\x9b\xff\x25\xb8\xfa\xe9\xc8\xa6\x3f\xe8\x0d\x9e\xa9</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># encrypted shellcode</span>
</span></span><span style="display:flex;"><span>                        
</span></span><span style="display:flex;"><span>iv <span style="color:#f92672">=</span><span style="color:#ae81ff">86225370279291231266238124133917033753321926857843067389263155507994576978348</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">banner</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ________________________________________________________
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         &lt;The &#34;AEShellCrypter&#34; - Encrypt your shellcode with AES &gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        --------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            \   ^__^
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            \   (oo)\_______
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                (__)\       )\/</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    ||----w |
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    ||     ||       
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         &#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#----------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Crypter</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">randomKeyGenerator</span>(self):
</span></span><span style="display:flex;"><span>        alphabet <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>ascii_letters <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>punctuation
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(secrets<span style="color:#f92672">.</span>choice(alphabet) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">16</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> str<span style="color:#f92672">.</span>encode(key) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self,key<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> key <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>key <span style="color:#f92672">=</span> str<span style="color:#f92672">.</span>encode(key)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;[*] Key Provided. Doing magic with it&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>randomKeyGenerator()
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;[*] Doing magic with a (pseudo) Random key&#34;</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;[*] Key: &#34;</span><span style="color:#f92672">+</span>self<span style="color:#f92672">.</span>key<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encrypt</span>(self, shellcode):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#iv = secrets.randbits(256) # for random IV</span>
</span></span><span style="display:flex;"><span>        aes <span style="color:#f92672">=</span> pyaes<span style="color:#f92672">.</span>AESModeOfOperationCTR(self<span style="color:#f92672">.</span>key, pyaes<span style="color:#f92672">.</span>Counter(iv))
</span></span><span style="display:flex;"><span>        crypted_shellcode <span style="color:#f92672">=</span> aes<span style="color:#f92672">.</span>encrypt(shellcode)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;IV: &#34;</span><span style="color:#f92672">+</span>str(iv))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#print(&#39;Encrypted:&#39;, crypted_shellcode)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        final_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> crypted_shellbyte <span style="color:#f92672">in</span> bytearray(crypted_shellcode):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            final_shellcode <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">x&#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%02x</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> crypted_shellbyte <span style="color:#75715e"># \x format</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># print encrypted shellcode in c-style format</span>
</span></span><span style="display:flex;"><span>        print()
</span></span><span style="display:flex;"><span>        print(final_shellcode)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt</span>(self, final_shellcode):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Decrypted&#34;</span>)
</span></span><span style="display:flex;"><span>        final_shellcode <span style="color:#f92672">=</span> bytes(final_shellcode, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;raw_unicode_escape&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        aes <span style="color:#f92672">=</span> pyaes<span style="color:#f92672">.</span>AESModeOfOperationCTR(self<span style="color:#f92672">.</span>key, pyaes<span style="color:#f92672">.</span>Counter(iv))
</span></span><span style="display:flex;"><span>        decrypted_shellcode <span style="color:#f92672">=</span> aes<span style="color:#f92672">.</span>decrypt(final_shellcode)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        original_shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> shellbyte <span style="color:#f92672">in</span> bytearray(decrypted_shellcode):
</span></span><span style="display:flex;"><span>            original_shellcode <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">x&#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%02x</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> shellbyte <span style="color:#75715e"># \x format</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> original_shellcode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#print(binascii.hexlify(bytearray(final_shellcode.replace(&#34;\\x&#34;,&#34;&#34;).encode())))</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">executeShellcode</span>(original_shellcode):
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    file <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;shellcode.c&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>)
</span></span><span style="display:flex;"><span>    file<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        #include&lt;stdio.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        #include&lt;string.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        unsigned char code[] = </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#39;&#39;&#39;</span> <span style="color:#f92672">+</span> original_shellcode <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;&#39;&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        void main() {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            printf(</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">Shellcode Length:  </span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">, strlen(code));
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            int (*ret)() = (int(*)())code;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            ret();
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    file<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#34;gcc -fno-stack-protector -z execstack -m64 shellcode.c -o shellcode 2&gt;/dev/null&#34;</span>)
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#34;./shellcode&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#shellcode = bytearray(c_style_shellcode)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print(&#34;[*] Shellcode length: &#34;+str(len(shellcode))+&#34;\n&#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print(&#34;[*] Shellcode: &#34;+str(c_style_shellcode)+&#34;\n&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;[*] Encrypted Shellcode length: &#34;</span><span style="color:#f92672">+</span>str(len(shellcode))<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;[*] Encrypted Shellcode: &#34;</span><span style="color:#f92672">+</span>str(c_style_shellcode)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e"># dor dynamic c-style use bytes(final_shellcode, encoding=&#34;raw_unicode_escape&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># -------------------KEY-------------- </span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;B6*D+/5DQ$MFn&lt;T{&#34;</span>    <span style="color:#75715e"># example key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#key = None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#####################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    crypter <span style="color:#f92672">=</span> Crypter(key);
</span></span><span style="display:flex;"><span>    crypter<span style="color:#f92672">.</span>encrypt(shellcode)
</span></span><span style="display:flex;"><span>    original_shellcode <span style="color:#f92672">=</span> crypter<span style="color:#f92672">.</span>decrypt(encrypted_shellcode)
</span></span><span style="display:flex;"><span>    executeShellcode(original_shellcode)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    banner() <span style="color:#75715e"># displays the program banner</span>
</span></span><span style="display:flex;"><span>    main()
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">--------------------&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;[*] Hack the World!&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;--------------------&#34;</span>)
</span></span><span style="display:flex;"><span>    print()
</span></span><span style="display:flex;"><span>    print()
</span></span></code></pre></div><p>For <code>AES CTR mode</code>, we need to pay attention to the <code>iv</code> and <code>key</code> of the encryption process because they are a must for the decryption process.</p>
<p>Basically, this encryption does the following:</p>
<ul>
<li>accepts shellcode in <code>\x</code> format - <code>shellcode</code> variable;</li>
<li>generates a pseudorandom <code>key</code>  and <code>iv</code> or uses one provided by the user - <code>key</code> and <code>iv</code> variables;</li>
<li>prints the shellcode in <code>\x</code> format</li>
</ul>
<p>All this process is manual by the time of writing this post. The shellcode, iv, and encrypted shellcode are hardcoded.</p>
<p>For the decryption process:</p>
<ul>
<li>Just prepared the encrypted shellcode (<code>encrypted_shellcode</code> variable) for decryption as it receives a bytes object;</li>
<li>Use the encryption iv and key to decrypt the shellcode;</li>
</ul>
<p>Then, appends the decrypted shellcode to a <code>shellcode.c</code> program, compiles it with <code>gcc</code>, and  executes it.</p>
<p>Executing the python <code>Crypter</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>╭─edu@debian ~/Desktop/slae_x86_64/assignments/7-Custom-crypter ‹main●› 
</span></span><span style="display:flex;"><span>╰─$ python3 aesCrypter.py 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        ________________________________________________________
</span></span><span style="display:flex;"><span>         &lt;The <span style="color:#e6db74">&#34;AEShellCrypter&#34;</span> - Encrypt your shellcode with AES &gt;
</span></span><span style="display:flex;"><span>        --------------------------------------------------------
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">\ </span>  ^__^
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">\ </span>  <span style="color:#f92672">(</span>oo<span style="color:#f92672">)</span><span style="color:#ae81ff">\_</span>______
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">(</span>__<span style="color:#f92672">)</span><span style="color:#ae81ff">\ </span>      <span style="color:#f92672">)</span><span style="color:#ae81ff">\/\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                    <span style="color:#f92672">||</span>----w |
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">||</span>     <span style="color:#f92672">||</span>       
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>         
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Encrypted Shellcode length: <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Encrypted Shellcode: b<span style="color:#e6db74">&#39;H1\xc0PH\xbb/bin//shSH\x89\xe7PH\x89\xe2WH\x89\xe6H\x83\xc0;\x0f\x05&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Key Provided. Doing magic with it
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Key: B6*D+/5DQ$MFn&lt;T<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>IV: <span style="color:#ae81ff">86225370279291231266238124133917033753321926857843067389263155507994576978348</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">\x</span>97<span style="color:#ae81ff">\x</span>90<span style="color:#ae81ff">\x</span>e1<span style="color:#ae81ff">\x</span>60<span style="color:#ae81ff">\x</span>56<span style="color:#ae81ff">\x</span>70<span style="color:#ae81ff">\x</span>fc<span style="color:#ae81ff">\x</span>91<span style="color:#ae81ff">\x</span>60<span style="color:#ae81ff">\x</span>01<span style="color:#ae81ff">\x</span>a2<span style="color:#ae81ff">\x</span>cf<span style="color:#ae81ff">\x</span>29<span style="color:#ae81ff">\x</span>43<span style="color:#ae81ff">\x</span>67<span style="color:#ae81ff">\x</span>15<span style="color:#ae81ff">\x</span>9f<span style="color:#ae81ff">\x</span>73<span style="color:#ae81ff">\x</span>72<span style="color:#ae81ff">\x</span>9b<span style="color:#ae81ff">\x</span>ff<span style="color:#ae81ff">\x</span>25<span style="color:#ae81ff">\x</span>b8<span style="color:#ae81ff">\x</span>fa<span style="color:#ae81ff">\x</span>e9<span style="color:#ae81ff">\x</span>c8<span style="color:#ae81ff">\x</span>a6<span style="color:#ae81ff">\x</span>3f<span style="color:#ae81ff">\x</span>e8<span style="color:#ae81ff">\x</span>0d<span style="color:#ae81ff">\x</span>9e<span style="color:#ae81ff">\x</span>a9
</span></span><span style="display:flex;"><span>Decrypted
</span></span><span style="display:flex;"><span>Shellcode Length:  <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>$ 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--------------------
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Hack the World!
</span></span><span style="display:flex;"><span>--------------------
</span></span></code></pre></div><blockquote>
<p>Improving this script is a future work to be performed. Working with different types in Python is a time-consuming task and requires some ability to handle it.</p>
</blockquote>
<hr>
<p>This blog post has been created for completing the requirements of the x86_64 Assembly Language and Shellcoding on Linux (SLAE64): <a href="https://www.pentesteracademy.com/course?id=7">https://www.pentesteracademy.com/course?id=7</a></p>
<p><code>Student ID: PA-31319</code></p>
<p>All the source code files are available on GitHub at <a href="https://github.com/0xnibbles/slae_x86_64">https://github.com/0xnibbles/slae_x86_64</a></p>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://0xnibbles.github.io/tags/slae64/">slae64</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://0xnibbles.github.io/posts/nday/zdi-17-836/">
    <span class="title">« Prev</span>
    <br>
    <span>ZDI-17-836 - dbman Opcode 10012 Use-After-Free Remote Code Execution</span>
  </a>
  <a class="next" href="https://0xnibbles.github.io/posts/slae64/slae_64_assignment_6/">
    <span class="title">Next »</span>
    <br>
    <span>SLAE64 Assignment 6 - Polymorphic Shellcode</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share SLAE64 Assignment 7 - Custom Crypter on twitter"
        href="https://twitter.com/intent/tweet/?text=SLAE64%20Assignment%207%20-%20Custom%20Crypter&amp;url=https%3a%2f%2f0xnibbles.github.io%2fposts%2fslae64%2fslae_64_assignment_7%2f&amp;hashtags=slae64">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share SLAE64 Assignment 7 - Custom Crypter on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2f0xnibbles.github.io%2fposts%2fslae64%2fslae_64_assignment_7%2f&amp;title=SLAE64%20Assignment%207%20-%20Custom%20Crypter&amp;summary=SLAE64%20Assignment%207%20-%20Custom%20Crypter&amp;source=https%3a%2f%2f0xnibbles.github.io%2fposts%2fslae64%2fslae_64_assignment_7%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
</div>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://0xnibbles.github.io/">nibbles</a></span>
   
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
