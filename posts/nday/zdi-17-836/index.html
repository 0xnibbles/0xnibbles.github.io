<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ZDI-17-836 - dbman Opcode 10012 Use-After-Free Remote Code Execution | nibbles</title>
<meta name="keywords" content="nday, ZDI-17-836, CVE-2017-12561, UAF">
<meta name="description" content="Introduction The present document analyzes previous disclosed use-after-free in Hewlett Packard Enterprise Intelligent Management Center, a network management platform. The vulnerability was reported by Steven Seeley to the Zero Day Initiative (ZDI) disclosure program identified as CVE-2017-12561.
The flaw allows to perform an unauthenticated remote attack and execute arbitrary code on vulnerable installations. HP fixed this vulnerability in October 2017, and all vulnerable instances should be updated to version HPE Intelligent Management Center (iMC) iMC Plat 7.">
<meta name="author" content="nibbles">
<link rel="canonical" href="https://0xnibbles.github.io/posts/nday/zdi-17-836/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css" integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://0xnibbles.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://0xnibbles.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://0xnibbles.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://0xnibbles.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://0xnibbles.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="ZDI-17-836 - dbman Opcode 10012 Use-After-Free Remote Code Execution" />
<meta property="og:description" content="Introduction The present document analyzes previous disclosed use-after-free in Hewlett Packard Enterprise Intelligent Management Center, a network management platform. The vulnerability was reported by Steven Seeley to the Zero Day Initiative (ZDI) disclosure program identified as CVE-2017-12561.
The flaw allows to perform an unauthenticated remote attack and execute arbitrary code on vulnerable installations. HP fixed this vulnerability in October 2017, and all vulnerable instances should be updated to version HPE Intelligent Management Center (iMC) iMC Plat 7." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://0xnibbles.github.io/posts/nday/zdi-17-836/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-25T18:36:39+00:00" />
<meta property="article:modified_time" content="2023-01-25T18:36:39+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ZDI-17-836 - dbman Opcode 10012 Use-After-Free Remote Code Execution"/>
<meta name="twitter:description" content="Introduction The present document analyzes previous disclosed use-after-free in Hewlett Packard Enterprise Intelligent Management Center, a network management platform. The vulnerability was reported by Steven Seeley to the Zero Day Initiative (ZDI) disclosure program identified as CVE-2017-12561.
The flaw allows to perform an unauthenticated remote attack and execute arbitrary code on vulnerable installations. HP fixed this vulnerability in October 2017, and all vulnerable instances should be updated to version HPE Intelligent Management Center (iMC) iMC Plat 7."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://0xnibbles.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ZDI-17-836 - dbman Opcode 10012 Use-After-Free Remote Code Execution",
      "item": "https://0xnibbles.github.io/posts/nday/zdi-17-836/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ZDI-17-836 - dbman Opcode 10012 Use-After-Free Remote Code Execution",
  "name": "ZDI-17-836 - dbman Opcode 10012 Use-After-Free Remote Code Execution",
  "description": "Introduction The present document analyzes previous disclosed use-after-free in Hewlett Packard Enterprise Intelligent Management Center, a network management platform. The vulnerability was reported by Steven Seeley to the Zero Day Initiative (ZDI) disclosure program identified as CVE-2017-12561.\nThe flaw allows to perform an unauthenticated remote attack and execute arbitrary code on vulnerable installations. HP fixed this vulnerability in October 2017, and all vulnerable instances should be updated to version HPE Intelligent Management Center (iMC) iMC Plat 7.",
  "keywords": [
    "nday", "ZDI-17-836", "CVE-2017-12561", "UAF"
  ],
  "articleBody": "Introduction The present document analyzes previous disclosed use-after-free in Hewlett Packard Enterprise Intelligent Management Center, a network management platform. The vulnerability was reported by Steven Seeley to the Zero Day Initiative (ZDI) disclosure program identified as CVE-2017-12561.\nThe flaw allows to perform an unauthenticated remote attack and execute arbitrary code on vulnerable installations. HP fixed this vulnerability in October 2017, and all vulnerable instances should be updated to version HPE Intelligent Management Center (iMC) iMC Plat 7.3 E0504P4 or earlier to avoid being exposed according to the released security security bulletin.\nBackground Before going deep into the details, we must be aware of some technical topics, namely the target installation environment and an overview of ASN.1 BER Encoding as the packets to communicate with the server are in this format.\nInstallation Environment Following the exercise’s description, the target was installed in a Microsoft Windows Server 2008 R2 virtual machine. It was a good challenge because everything was in this OS is obsolete. After looking at the manual, I could configure the SQL Server and the sa account. The installation of the patched version was straightforward - the same for applying the vulnerable binary as it was simply by installing its components.\nThe first task is to know how the software works. After reading the documentation,installing both vulnerable and patched versions of HP iMC, and saving the respective DBman binaries for further analysis using IDA.\nAs seen with the netstat command, port 2810 regarding DBman is listening, and the service is ready to be analyzed.\nDBman Running in MS Windows Server 2088 R2 Quick Intro to ASN.1 BER Encoding ASN.1 (Abstract Syntax Notation One) is a notation for describing abstract types. A type is a set of values. A value of a given ASN.1 type is an element of the type’s set. ASN.1 has four types: simple types, which are “atomic” and have no components; structured types, which have components; tagged types, which are derived from other types; and other types, which include the CHOICE type and the ANY type.\nThe following table shows a list of ASN.1 types.\nType Tag number (decimal) Tag number (hexadecimal) INTEGER 2 02 BIT STRING 3 03 OCTET STRING 4 04 NULL 05 05 OBJECT IDENTIFIER 6 06 SEQUENCE and SEQUECE OF 16 10 SET and SET OF 17 11 PrintableString 19 13 T61String 20 14 UTCTime 23 17 BER Encoding BER (Basic Encoding Rules) is a subset of the ASN.1 standard. Its purpose is to allow to encode or represent values of each ASN.1 type as octets. BER uses a form of encoding commonly known as Tag-Length-Value.\nEach item is encoded as a tag, indicating what type it is, a length implying the object’s size, and a value containing the object’s actual contents.\nThere are various methods to encode values using BER. For more detail, see here.\nVulnerability Analysis Patch Diffing The patch code (E0504) for this vuln should not suffer a lot of changes since it is a close release from the vulnerable version (E0504P04).\nUsing IDA with the BinDiff plugin can give an idea of what functions were modified.\nBinDiff output in IDA The matched functions tab shows two modified functions, sub_4562C0 and sub_46CFD0.\nOn the one hand, checking sub_4562C0, nothing, at first sight, looks to be relevant.\nOn the other hand, sub_46CFD0 seems to be interesting as it appears inside a big switch-case where the condition is the opcode (10012) described in the advisory.\nOpcode 10012 Switch-case Code These are good hints to discover the flow and trigger the use-after-free vulnerability.\nsub_46CFD0 function Inspecting this function, nothing looks to be related to a use-after-free. The next step is analyzing the code related to the 10012 opcode.\nCode Analysis Firstly, the code checks the number of bytes received from the socket according to the documentation.\nRecv Size Buffer ACE recv API It reads 4 bytes of data and allocates a buffer of that size. So from this code, we can think the software expects a packet with the format: opcode+size_buffer+buffer_data\nTesting it with a simple python client it logs some odd errors because everything should have the same size.\n#!/usr/bin/python3 from pwn import * from struct import pack, unpack def main(): host = '192.168.1.133' port = 2810 # default port according to documentation conn = remote(host, port) #sends --\u003e opcode,size of buffer being allocated, buffer data payload = b'' payload += pack('\u003ei',10012) # opcode payload += pack('\u003ei',144) # size of buffer payload += pack('\u003ei',0x41*144) # buffer data conn.sendline(payload) main() DBman logs the runtime errors in C:\\Program Files\\iMC\\dbman\\log\\dbman_debug.log. The following logs show the result triggered by the above script.\nLog Data length error Data length error code From the decompiled code, we identified the error message. This code block is executed when the size of buffer_data is not equal to size_buffer. In other words, it fails the check ( *(_DWORD *)recv_size_buffer == size_data ).\nLet’s examine the code in case this check is valid.\nData Buffer size check condition The first condition is checking if the size of the buffer sent in the packet corresponds to the data buffer size. After, check if the buffer data from the packet is correctly allocated to a buffer.\nData buffer length check function If everything goes well, an ASN object is created and releases the buffer sent with the packet using the free function. After it, as a good practice, the reference to this object is Nullified to clean the pointer.\nValid Buffer data length After this, a function named AsnRemoteReservedFileRemove looks to initialize an ASN object using octets.\nDecompiled asnRemoteReservedFileRemove Function After this function appears, another function with a variable with AsnRemoteReservedFileRemove::BDec attributed.\nAgain an ASN reference should be related to ANS.1 format. Searching on the internet for DBman and ASN keywords appeared, and some blog posts about other vulnerabilities in DBman.\nDecompiled asnRemoteReservedFileRemove::BDec Function I read this post about opcode 10020. The post mentions how DBman packets are constructed and confirms the use of ASN.1 BER encoded objects in the communication packets.\nObs: After researching what SNACC is, I found out that is a ASN.1 compiler to C/C++\nThe post mentions a client named Intelligent Deployment Monitoring Agent.\nIn fact, it makes sense if the DBman service is listening, a client to communicate with the server should exist.\nDecompiled Deploy.jar classes Inspecting the AsnRemoteReservedFileRemove.class, we the similarity with the decompiled we have seen previously.\nasnRemoteReservedFileRemove Function It seems to be a custom implementation of ASN.1 BER Encoded packets for DBman. Now we can build our client as we know the packet structure accepted by the server.\n#################################### # ASN.1 BER encoded packets script # #################################### #!/usr/bin/python3 from pwn import * from struct import pack, unpack from pyasn1.type.univ import Sequence, OctetString, Integer, Null from pyasn1.codec.ber import encoder import time class AsnRemoteReservedFileRemove(): def __init__(self, reservedFilePath, backupPath, backFileExt, time): #super(AsnRemoteReservedFileRemove, self).__init__() self.reservedFilePath = reservedFilePath self.backupPath = backupPath self.backFileExt = backFileExt self.time = time def encode(self): self.message = Sequence() self.message.setComponentByPosition(0, OctetString(self.reservedFilePath)) self.message.setComponentByPosition(1, OctetString(self.backupPath)) self.message.setComponentByPosition(2, OctetString(self.backFileExt)) self.message.setComponentByPosition(3, Integer(self.time)) self.message.setComponentByPosition(4, Null()) return encoder.encode(self.message) def main(): host = '192.168.1.133' port = 2810 # default port according to documentation conn = remote(host, port) # sends --\u003e opcode,size of buffer being allocated, buffer data msg_obj = AsnRemoteReservedFileRemove(\"C:\\\\Users\\\\Eduardo\\\\down.PS1\", \"C:\\\\Users\\\\Eduardo\\\\imc_patched\\down.PS1\",\".log\", time.time()) asnEncoded_msg = msg_obj.encode() payload = b'' payload += pack('\u003ei',10012) # opcode payload += pack('\u003ei',len(asnEncoded_msg)) # size of buffer payload += asnEncoded_msg # buffer data conn.sendline(payload) main() With this script, I could unintentionally trigger an error that appeared to crash DBman.\nDBman crash log Why this failed?\nSomehow the if condition was true. Inside it is the string “dbman_decode_len failed” which was the one logged when the crash happened. So this function must somehow be trying to decode the ASN.1 object sent in the packet, which failed during the process.\ndbman_decode_len function prototype Checking the decompiled jar, there is no reference to this string. Analyzing the function looks like it is trying to check if the size from the data_buffer is right and tries to store the length in a variable if the check is acceptable.\nFor curiosity checked aLiuan814ucj variable reference. It is located in the data section, which seems to be a string already present at the compilation time.\naLiuan814ucj in data section Looking in the decompiled jar and found it being used as a key with DES symmetric algorithm.\naLiuan814ucj in deploy.jar So sub_454120 should be related to DES decryption using liuan814 as the key. Not sure if this is the case, but since the function is about decoding the ASN.1 object, it seems to be trying to decipher the data_buffer and check if everything goes well. \\\nThe function sub_454BA0 with the rest division by 8 appears to check if the data_buffer octets are compliant. As it deals with ASN.1 OctetString types, the remainder should always be zero. If not, there is something wrong with the object.\nCheck data_buffer ASN.1 octets When successful returns the buffer size. If the payload triggered the error, the ASN.1 object octets remainder after division should not be zero. Printing the size of the encoded BER object, it outputs 90.\nPayload Size that triggers the crash 90 % 8 = 11,25 The remainder is not zero, so DBman can’t decode the object and logs the error. DBman, after that, crashes and reboots. Something unusual is happening after the logging function (sub_475470). In this case function, sub_45EC20 should have an issue.\nCode location where the crash occurs Use-After-Free (UAF) Root Cause Analysis Checking sub_45EC20, there is no relevant information.\nIDA subEC20 decompiled function Checking the disassembled view of this function, there is no interesting information too.\nIDA subEC20 disassembled function But there are two paths the flow can take. Let’s debug the software to get more details. Olly Debugger was the debugger used for this task.\nAttaching dbman.exe process to Olly Debugger Putting a breakpoint in 0045EC20, which is the address of sub_45EC200. The plan is to execute the payload and iterate with Ollydbg and see what happens when the application crashes.\nDebugging subEC20 Iterating through these instructions at address 0045EC63 (call EAX), there is a call to a resolved address (0045EAB0) in runtime.\nResolving 45EAB0 function address in runtime Also, we can see the payload in memory.\nPayload in memory The application flow is redirected to a new complete function that could be resolved by looking at the decompiler. Keeping stepping forward, it appears to be a free function. The pointer to be freed is 027A95E0.\nJump to free function After jumping to that function, the HeapFree function frees the pointer 027A95E0. According to the documentation, this function frees a memory block allocated from a heap.\nThe pointer seen before is as pMemory argument (a pointer to the memory block to be freed).\nCall to HeapFree function Checking the contents pointed by this pointer before being freed.\nBlock content before being freed After executing the HeapFree function, the block content is overwritten by junk data. 027A95E0 points to a new address -\u003e 027A9760.\nAfter freeing the pointer Continuing to step forward, we reached a part of the code where is used the pointer 027A95E0(released before). The content (027A9760) of the pointer is copied to EAX.\nThe next instruction is to use the content of this pointer as a reference (DWORD PTR DS: [EAX + 14]). After dereferencing, the relative address points to junk data, as seen in the image below.\nDereferencing relative address based in the freed pointer The junk data is copied to EDX, which will be used with a Call instruction a few instructions below. Stepping to reach the call EDX, we see the redirection address FEEEFEEE.\nAccess Violation Redirecting to this address triggers an access violation, and the program crashes.\nCrash after access violation, use-after-free Conclusion: The crash occurs because the application tries to dereference a previously freed pointer, resulting in a Use-After-Free.\nExtra After resolving the call to EAX, the address of sub_0045EAB0 in OllyDbg, checking that function in IDA, there is a call to operator delete.\nsub_0045EAB0 function in IDA Comparing the code decompiled by IDA and what was presented by OllyDbg, delete and free are equivalent functions as described here.\n",
  "wordCount" : "2010",
  "inLanguage": "en",
  "datePublished": "2023-01-25T18:36:39Z",
  "dateModified": "2023-01-25T18:36:39Z",
  "author":{
    "@type": "Person",
    "name": "nibbles"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://0xnibbles.github.io/posts/nday/zdi-17-836/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "nibbles",
    "logo": {
      "@type": "ImageObject",
      "url": "https://0xnibbles.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://0xnibbles.github.io/" accesskey="h" title="nibbles (Alt + H)">nibbles</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://0xnibbles.github.io/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/about.html" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://0xnibbles.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://0xnibbles.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://0xnibbles.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      ZDI-17-836 - dbman Opcode 10012 Use-After-Free Remote Code Execution
    </h1>
    <div class="post-meta"><span title='2023-01-25 18:36:39 +0000 UTC'>January 25, 2023</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;nibbles

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#background" aria-label="Background">Background</a><ul>
                        
                <li>
                    <a href="#installation-environment" aria-label="Installation Environment">Installation Environment</a></li>
                <li>
                    <a href="#quick-intro-to-asn1-ber-encoding" aria-label="Quick Intro to ASN.1 BER Encoding">Quick Intro to ASN.1 BER Encoding</a></li>
                <li>
                    <a href="#ber-encoding" aria-label="BER Encoding">BER Encoding</a></li></ul>
                </li>
                <li>
                    <a href="#vulnerability-analysis" aria-label="Vulnerability Analysis">Vulnerability Analysis</a><ul>
                        
                <li>
                    <a href="#patch-diffing" aria-label="Patch Diffing">Patch Diffing</a></li>
                <li>
                    <a href="#code-analysis" aria-label="Code Analysis">Code Analysis</a></li></ul>
                </li>
                <li>
                    <a href="#use-after-free-uaf" aria-label="Use-After-Free (UAF)">Use-After-Free (UAF)</a><ul>
                        
                <li>
                    <a href="#root-cause-analysis" aria-label="Root Cause Analysis">Root Cause Analysis</a></li></ul>
                </li>
                <li>
                    <a href="#extra" aria-label="Extra">Extra</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>The present document analyzes previous disclosed <a href="https://www.zerodayinitiative.com/advisories/ZDI-17-836/">use-after-free</a> in <a href="https://www.hpe.com/us/en/networking/management.html">Hewlett Packard Enterprise Intelligent Management Center</a>, a network management platform. The vulnerability was reported by Steven Seeley to the Zero Day Initiative (ZDI) disclosure program identified as <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-12561">CVE-2017-12561</a>.</p>
<p>The flaw allows to perform an unauthenticated remote attack and execute arbitrary code on vulnerable installations. HP fixed this vulnerability in October 2017, and all vulnerable instances should be updated to version HPE Intelligent Management Center (iMC) iMC Plat 7.3 E0504P4 or earlier to avoid being exposed according to the released security security bulletin.</p>
<h2 id="background">Background<a hidden class="anchor" aria-hidden="true" href="#background">#</a></h2>
<p>Before going deep into the details, we must be aware of some technical topics, namely the target installation environment and an overview of ASN.1 BER Encoding as the packets to communicate with the server are in this format.</p>
<h3 id="installation-environment">Installation Environment<a hidden class="anchor" aria-hidden="true" href="#installation-environment">#</a></h3>
<p>Following the exercise’s description, the target was installed in a <code>Microsoft Windows Server 2008 R2</code> virtual machine. It was a good challenge because everything was
in this OS is obsolete. After looking at the manual, I could configure the SQL Server and the sa account. The installation of the patched version was straightforward - the same for applying the vulnerable binary as it was simply by installing its components.</p>
<p>The first task is to know how the software works. After reading the <a href="https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapfree">documentation</a>,installing both vulnerable and patched versions of HP iMC, and saving the respective  DBman binaries for further analysis using IDA.</p>
<p>As seen with the netstat command, port <code>2810</code> regarding DBman is listening, and the service is ready to be analyzed.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/installed_env.jpg#center" alt="DBman Running in MS Windows Server 2088 R2">
    <figcaption style='text-align: center'>DBman Running in MS Windows Server 2088 R2</figcaption>
  </figure>
</p>
<h3 id="quick-intro-to-asn1-ber-encoding">Quick Intro to ASN.1 BER Encoding<a hidden class="anchor" aria-hidden="true" href="#quick-intro-to-asn1-ber-encoding">#</a></h3>
<p>ASN.1 (Abstract Syntax Notation One) is a notation for describing abstract types. A type is a set of values. A value of a given ASN.1 type is an element of the type’s set. ASN.1 has four types: simple types, which are &ldquo;atomic&rdquo; and have no components; structured types, which have components; tagged types, which are derived from other types; and other types, which include the CHOICE type and the ANY type.</p>
<p>The following table shows a list of ASN.1 types.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Type</th>
<th style="text-align:center">Tag number (decimal)</th>
<th style="text-align:center">Tag number (hexadecimal)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">INTEGER</td>
<td style="text-align:center">2</td>
<td style="text-align:center">02</td>
</tr>
<tr>
<td style="text-align:center">BIT STRING</td>
<td style="text-align:center">3</td>
<td style="text-align:center">03</td>
</tr>
<tr>
<td style="text-align:center">OCTET STRING</td>
<td style="text-align:center">4</td>
<td style="text-align:center">04</td>
</tr>
<tr>
<td style="text-align:center">NULL</td>
<td style="text-align:center">05</td>
<td style="text-align:center">05</td>
</tr>
<tr>
<td style="text-align:center">OBJECT IDENTIFIER</td>
<td style="text-align:center">6</td>
<td style="text-align:center">06</td>
</tr>
<tr>
<td style="text-align:center">SEQUENCE and SEQUECE OF</td>
<td style="text-align:center">16</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">SET and SET OF</td>
<td style="text-align:center">17</td>
<td style="text-align:center">11</td>
</tr>
<tr>
<td style="text-align:center">PrintableString</td>
<td style="text-align:center">19</td>
<td style="text-align:center">13</td>
</tr>
<tr>
<td style="text-align:center">T61String</td>
<td style="text-align:center">20</td>
<td style="text-align:center">14</td>
</tr>
<tr>
<td style="text-align:center">UTCTime</td>
<td style="text-align:center">23</td>
<td style="text-align:center">17</td>
</tr>
</tbody>
</table>
<h3 id="ber-encoding">BER Encoding<a hidden class="anchor" aria-hidden="true" href="#ber-encoding">#</a></h3>
<p>BER (<em>Basic Encoding Rules</em>) is a subset of the ASN.1 standard. Its purpose is to allow to encode or represent values of each <code>ASN.1</code> type as octets. BER uses a form of encoding commonly known as <code>Tag-Length-Value</code>.<br>
Each item is encoded as a tag, indicating what type it is, a length implying the object’s size, and a value containing the object’s actual contents.</p>
<p>There are various methods to encode values using BER. For more detail, see <a href="https://luca.ntop.org/Teaching/Appunti/asn1.html">here</a>.</p>
<h2 id="vulnerability-analysis">Vulnerability Analysis<a hidden class="anchor" aria-hidden="true" href="#vulnerability-analysis">#</a></h2>
<h3 id="patch-diffing">Patch Diffing<a hidden class="anchor" aria-hidden="true" href="#patch-diffing">#</a></h3>
<p>The patch code (<strong>E0504</strong>) for this vuln should not suffer a lot of changes since it is a close release from the vulnerable version (<strong>E0504P04</strong>).</p>
<p>Using IDA with the BinDiff plugin can give an idea of what functions were modified.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/patch_diff/bindiff.png" alt="BinDiff output in IDA">
    <figcaption style='text-align: center'>BinDiff output in IDA</figcaption>
  </figure>
</p>
<p>The matched functions tab shows two modified functions, sub_4562C0 and <strong>sub_46CFD0</strong>.</p>
<p>On the one hand, checking <strong>sub_4562C0</strong>, nothing, at first sight, looks to be relevant.<br>
On the other hand, <strong>sub_46CFD0</strong> seems to be interesting as it appears inside a big switch-case where the condition is the opcode (<strong>10012</strong>) described in the advisory.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/patch_diff/case10012.png" alt="Opcode 10012 Switch-case Code">
    <figcaption style='text-align: center'>Opcode 10012 Switch-case Code</figcaption>
  </figure>
</p>
<p>These are good hints to discover the flow and trigger the use-after-free vulnerability.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/patch_diff/sub_46CFD0.png" alt="sub_46CFD0 function">
    <figcaption style='text-align: center'>sub_46CFD0 function</figcaption>
  </figure>
</p>
<p>Inspecting this function, nothing looks to be related to a use-after-free. The next step is analyzing the code related to the <code>10012 opcode</code>.</p>
<h3 id="code-analysis">Code Analysis<a hidden class="anchor" aria-hidden="true" href="#code-analysis">#</a></h3>
<p>Firstly, the code checks the number of bytes received from the socket according to the documentation.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/received_size_buffer.png" alt="Recv Size Buffer">
    <figcaption style='text-align: center'>Recv Size Buffer</figcaption>
  </figure>
</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/api_sock.png" alt="ACE recv API">
    <figcaption style='text-align: center'>ACE recv API</figcaption>
  </figure>
</p>
<p>It reads 4 bytes of data and allocates a buffer of that size. So from this code, we can think the software expects a packet with the format: <strong>opcode+size_buffer+buffer_data</strong></p>
<p>Testing it with a simple python client it logs some odd errors because everything should have the same size.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> struct <span style="color:#f92672">import</span> pack, unpack
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;192.168.1.133&#39;</span>
</span></span><span style="display:flex;"><span>    port <span style="color:#f92672">=</span> <span style="color:#ae81ff">2810</span> <span style="color:#75715e"># default port according to documentation</span>
</span></span><span style="display:flex;"><span>    conn <span style="color:#f92672">=</span> remote(host, port)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#sends --&gt; opcode,size of buffer being allocated, buffer data</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pack(<span style="color:#e6db74">&#39;&gt;i&#39;</span>,<span style="color:#ae81ff">10012</span>) <span style="color:#75715e"># opcode</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pack(<span style="color:#e6db74">&#39;&gt;i&#39;</span>,<span style="color:#ae81ff">144</span>) <span style="color:#75715e"># size of buffer</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pack(<span style="color:#e6db74">&#39;&gt;i&#39;</span>,<span style="color:#ae81ff">0x41</span><span style="color:#f92672">*</span><span style="color:#ae81ff">144</span>) <span style="color:#75715e"># buffer data</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main()
</span></span></code></pre></div><p>DBman logs the runtime errors in <code>C:\Program Files\iMC\dbman\log\dbman_debug.log</code>. The following logs show
the result triggered by the above script.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/log_data_len_error.png#center" alt="Log Data length error">
    <figcaption style='text-align: center'>Log Data length error</figcaption>
  </figure>
</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/data_len_error.png#center" alt="Data length error code">
    <figcaption style='text-align: center'>Data length error code</figcaption>
  </figure>
</p>
<p>From the decompiled code, we identified the error message. This code block is executed when the size of buffer_data is not equal to size_buffer. In other words, it fails the check <strong>( *(_DWORD *)recv_size_buffer == size_data )</strong>.</p>
<p>Let’s examine the code in case this check is valid.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/if_condition.png#center" alt="Data Buffer size check condition">
    <figcaption style='text-align: center'>Data Buffer size check condition</figcaption>
  </figure>
</p>
<p>The first condition is checking if the size of the buffer sent in the packet corresponds to the data buffer size. After, check if the buffer data from the packet is correctly allocated to a buffer.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/dbman_decode.png#center" alt="Data buffer length check function">
    <figcaption style='text-align: center'>Data buffer length check function</figcaption>
  </figure>
</p>
<p>If everything goes well, an ASN object is created and releases the buffer sent with the packet using the free function. After it, as a good practice, the reference to this object is Nullified to clean the pointer.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/else_code.png#center" alt="Valid Buffer data length">
    <figcaption style='text-align: center'>Valid Buffer data length</figcaption>
  </figure>
</p>
<p>After this, a function named <strong>AsnRemoteReservedFileRemove</strong> looks to initialize an ASN object using octets.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/init_asnRemoteReservedFileRemove.png#center" alt="Decompiled asnRemoteReservedFileRemove Function">
    <figcaption style='text-align: center'>Decompiled asnRemoteReservedFileRemove Function</figcaption>
  </figure>
</p>
<p>After this function appears, another function with a variable with <strong>AsnRemoteReservedFileRemove::BDec</strong> attributed.<br>
Again an ASN reference should be related to ANS.1 format. Searching on the internet for <em><strong>DBman</strong></em> and <em><strong>ASN</strong></em> keywords appeared, and some blog posts about other vulnerabilities in DBman.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/asnRemoteReservedFileRemove::BDec.jpg#center" alt="Decompiled asnRemoteReservedFileRemove::BDec Function">
    <figcaption style='text-align: center'>Decompiled asnRemoteReservedFileRemove::BDec Function</figcaption>
  </figure>
</p>
<p>I read this <a href="https://medium.com/tenable-techblog/hpe-imc-hunting-the-hunted-2619889802ab">post</a> about opcode 10020. The post mentions how DBman packets are constructed and confirms the use of ASN.1 BER encoded objects in the communication packets.</p>
<p><code>Obs: After researching what SNACC is, I found out that is a ASN.1 compiler to C/C++</code></p>
<p>The post mentions a client named <strong>Intelligent Deployment Monitoring Agent</strong>.</p>
<p>In fact, it makes sense if the DBman service is listening, a client to communicate with the
server should exist.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/asn_classes.png#center" alt="Decompiled Deploy.jar classes">
    <figcaption style='text-align: center'>Decompiled Deploy.jar classes</figcaption>
  </figure>
</p>
<p>Inspecting the <strong>AsnRemoteReservedFileRemove.class</strong>, we the similarity with the decompiled we have seen previously.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/asnRemoteReservedFileRemove.png#center" alt="asnRemoteReservedFileRemove Function">
    <figcaption style='text-align: center'>asnRemoteReservedFileRemove Function</figcaption>
  </figure>
</p>
<p>It seems to be a <strong>custom implementation</strong> of ASN.1 BER Encoded packets for DBman. Now we can build our client as we know the packet structure accepted by the server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">####################################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ASN.1 BER encoded packets script #</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> struct <span style="color:#f92672">import</span> pack, unpack
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyasn1.type.univ <span style="color:#f92672">import</span> Sequence, OctetString, Integer, Null
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pyasn1.codec.ber <span style="color:#f92672">import</span> encoder
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AsnRemoteReservedFileRemove</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, reservedFilePath, backupPath, backFileExt, time):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#super(AsnRemoteReservedFileRemove, self).__init__()</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>reservedFilePath <span style="color:#f92672">=</span> reservedFilePath
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>backupPath <span style="color:#f92672">=</span> backupPath
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>backFileExt <span style="color:#f92672">=</span> backFileExt
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>time <span style="color:#f92672">=</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>message <span style="color:#f92672">=</span> Sequence()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>message<span style="color:#f92672">.</span>setComponentByPosition(<span style="color:#ae81ff">0</span>, OctetString(self<span style="color:#f92672">.</span>reservedFilePath))
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>message<span style="color:#f92672">.</span>setComponentByPosition(<span style="color:#ae81ff">1</span>, OctetString(self<span style="color:#f92672">.</span>backupPath))
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>message<span style="color:#f92672">.</span>setComponentByPosition(<span style="color:#ae81ff">2</span>, OctetString(self<span style="color:#f92672">.</span>backFileExt))
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>message<span style="color:#f92672">.</span>setComponentByPosition(<span style="color:#ae81ff">3</span>, Integer(self<span style="color:#f92672">.</span>time))
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>message<span style="color:#f92672">.</span>setComponentByPosition(<span style="color:#ae81ff">4</span>, Null())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> encoder<span style="color:#f92672">.</span>encode(self<span style="color:#f92672">.</span>message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;192.168.1.133&#39;</span>
</span></span><span style="display:flex;"><span>    port <span style="color:#f92672">=</span> <span style="color:#ae81ff">2810</span> <span style="color:#75715e"># default port according to documentation</span>
</span></span><span style="display:flex;"><span>    conn <span style="color:#f92672">=</span> remote(host, port)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># sends --&gt; opcode,size of buffer being allocated, buffer data    </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    msg_obj <span style="color:#f92672">=</span> AsnRemoteReservedFileRemove(<span style="color:#e6db74">&#34;C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Eduardo</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">down.PS1&#34;</span>, <span style="color:#e6db74">&#34;C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Eduardo</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">imc_patched\down.PS1&#34;</span>,<span style="color:#e6db74">&#34;.log&#34;</span>, time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>    asnEncoded_msg <span style="color:#f92672">=</span> msg_obj<span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pack(<span style="color:#e6db74">&#39;&gt;i&#39;</span>,<span style="color:#ae81ff">10012</span>) <span style="color:#75715e"># opcode</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> pack(<span style="color:#e6db74">&#39;&gt;i&#39;</span>,len(asnEncoded_msg)) <span style="color:#75715e"># size of buffer</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> asnEncoded_msg <span style="color:#75715e"># buffer data</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main()
</span></span></code></pre></div><p>With this script, I could unintentionally trigger an error that appeared to crash DBman.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/log_crash.png" alt="DBman crash log">
    <figcaption style='text-align: center'>DBman crash log</figcaption>
  </figure>
</p>
<blockquote>
<p><strong>Why this failed?</strong></p>
</blockquote>
<p>Somehow the if condition was <strong>true</strong>. Inside it is the string <strong>&ldquo;dbman_decode_len failed&rdquo;</strong> which was the one logged when the crash happened. So this function must
somehow be trying to decode the ASN.1 object sent in the packet, which failed during the process.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/if_dbman_decode_len.png" alt="dbman_decode_len function prototype">
    <figcaption style='text-align: center'>dbman_decode_len function prototype</figcaption>
  </figure>
</p>
<p>Checking the decompiled jar, there is no reference to this string. Analyzing the function looks like it is trying to check if the size from the <em>data_buffer</em> is right and tries to store the length in a variable if the check is acceptable.</p>
<p>For curiosity checked <em>aLiuan814ucj</em> variable reference. It is located in the data section, which seems to be a string already present at the compilation time.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/des_key_data_section.png#center" alt="aLiuan814ucj in data section">
    <figcaption style='text-align: center'>aLiuan814ucj in data section</figcaption>
  </figure>
</p>
<p>Looking in the decompiled jar and found it being used as a key with <strong>DES symmetric algorithm</strong>.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/des_key_java.png#center" alt="aLiuan814ucj in deploy.jar">
    <figcaption style='text-align: center'>aLiuan814ucj in deploy.jar</figcaption>
  </figure>
</p>
<p>So <strong>sub_454120</strong> should be related to DES decryption using <em><strong>liuan814</strong></em> as the key. Not sure if this is the case, but since the function is about decoding the ASN.1 object, it seems to be trying to decipher the data_buffer and check if everything goes well. \</p>
<p>The function <strong>sub_454BA0</strong> with the rest division by 8 appears to check if the <em>data_buffer</em> octets are compliant. As it deals with ASN.1 OctetString types, the remainder should always be zero. If not, there is something wrong with the object.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/check_octets.png#center" alt="Check data_buffer ASN.1 octets">
    <figcaption style='text-align: center'>Check data_buffer ASN.1 octets</figcaption>
  </figure>
</p>
<p>When successful returns the buffer size. If the payload triggered the error, the ASN.1 object octets remainder after division should not be zero. Printing the size of the encoded BER object, it outputs <strong>90</strong>.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/payload_size.png#center" alt="Payload Size that triggers the crash">
    <figcaption style='text-align: center'>Payload Size that triggers the crash</figcaption>
  </figure>
</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"><strong>90</strong> % 8 = 11,25</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>The remainder is not zero, so DBman can’t decode the object and logs the error. DBman, after that, <strong>crashes and reboots</strong>. Something unusual is happening after the logging function (sub_475470). In this case function, <strong>sub_45EC20</strong> should have an issue.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/code_analysis/uaf_function.png#center" alt="Code location where the crash occurs">
    <figcaption style='text-align: center'>Code location where the crash occurs</figcaption>
  </figure>
</p>
<h2 id="use-after-free-uaf">Use-After-Free (UAF)<a hidden class="anchor" aria-hidden="true" href="#use-after-free-uaf">#</a></h2>
<h3 id="root-cause-analysis">Root Cause Analysis<a hidden class="anchor" aria-hidden="true" href="#root-cause-analysis">#</a></h3>
<p>Checking <strong>sub_45EC20</strong>, there is no relevant information.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/sub_EC20_function_decompiled.jpg#center" alt="IDA subEC20 decompiled function">
    <figcaption style='text-align: center'>IDA subEC20 decompiled function</figcaption>
  </figure>
</p>
<p>Checking the disassembled view of this function, there is no interesting information too.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis//ida_subec20.jpg#center" alt="IDA subEC20 disassembled function">
    <figcaption style='text-align: center'>IDA subEC20 disassembled function</figcaption>
  </figure>
</p>
<p>But there are two paths the flow can take. Let&rsquo;s debug the software to get more details. Olly Debugger was the debugger used for this task.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/ollydbg.jpg#center" alt="Attaching dbman.exe process to Olly Debugger">
    <figcaption style='text-align: center'>Attaching dbman.exe process to Olly Debugger</figcaption>
  </figure>
</p>
<p>Putting a breakpoint in <strong>0045EC20</strong>, which is the address of <strong>sub_45EC200</strong>. The plan is to execute the payload and iterate with Ollydbg and see what happens when the
application crashes.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/ollydbg_disas_subec20.jpg#center" alt="Debugging subEC20">
    <figcaption style='text-align: center'>Debugging subEC20</figcaption>
  </figure>
</p>
<p>Iterating through these instructions at address <strong>0045EC63</strong> (<code>call EAX</code>), there is a call to a resolved address (<strong>0045EAB0</strong>) in runtime.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/eax_dbman_0045EAB0.jpg#center" alt="Resolving 45EAB0 function address in runtime">
    <figcaption style='text-align: center'>Resolving 45EAB0 function address in runtime</figcaption>
  </figure>
</p>
<p>Also, we can see the payload in memory.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/payload_in_memory.jpg#center" alt="Payload in memory">
    <figcaption style='text-align: center'>Payload in memory</figcaption>
  </figure>
</p>
<p>The application flow is redirected to a new complete function that could be resolved by looking at the decompiler. Keeping stepping forward, it appears to be a free function. The pointer to be freed is <strong>027A95E0</strong>.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/uaf/jmp_free.jpg#center" alt="Jump to free function">
    <figcaption style='text-align: center'>Jump to free function</figcaption>
  </figure>
</p>
<p>After jumping to that function, the HeapFree function frees the pointer <strong>027A95E0</strong>. According to the documentation, this function frees a memory block allocated from a heap.</p>
<p>The pointer seen before is as <strong>pMemory</strong> argument (a pointer to the memory block to be freed).</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/uaf/call_HeapFree.jpg#center" alt="Call to HeapFree function">
    <figcaption style='text-align: center'>Call to HeapFree function</figcaption>
  </figure>
</p>
<p>Checking the contents pointed by this pointer before being freed.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/uaf/heap_block_pointer_content.jpg#center" alt="Block content before being freed">
    <figcaption style='text-align: center'>Block content before being freed</figcaption>
  </figure>
</p>
<p>After executing the HeapFree function, the block content is overwritten by junk data. <strong>027A95E0</strong> points to a new address -&gt; <strong>027A9760</strong>.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/uaf/after_heapFree.jpg#center" alt="After freeing the pointer">
    <figcaption style='text-align: center'>After freeing the pointer</figcaption>
  </figure>
</p>
<p>Continuing to step forward, we reached a part of the code where is used the pointer <strong>027A95E0</strong>(released before). The content (027A9760) of the pointer is copied to EAX.</p>
<p>The next instruction is to use the content of this pointer as a reference (<strong>DWORD PTR DS: [EAX + 14]</strong>). After dereferencing, the relative address points to junk data, as seen in the image below.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/uaf/data_string_freed_pointer.jpg#center" alt="Dereferencing relative address based in the freed pointer">
    <figcaption style='text-align: center'>Dereferencing relative address based in the freed pointer</figcaption>
  </figure>
</p>
<p>The junk data is copied to EDX, which will be used with a Call instruction a few instructions below. Stepping to reach the call EDX, we see the redirection address <strong>FEEEFEEE</strong>.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/uaf/access_violation.jpg#center" alt="Access Violation">
    <figcaption style='text-align: center'>Access Violation</figcaption>
  </figure>
</p>
<p>Redirecting to this address triggers an access violation, and the program crashes.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/uaf/crash_after_access_violation%28uaf%29.jpg#center" alt="Crash after access violation, use-after-free">
    <figcaption style='text-align: center'>Crash after access violation, use-after-free</figcaption>
  </figure>
</p>
<blockquote>
<p><strong>Conclusion</strong>: The crash occurs because the application tries to dereference a previously freed pointer, resulting in a Use-After-Free.</p>
</blockquote>
<h2 id="extra">Extra<a hidden class="anchor" aria-hidden="true" href="#extra">#</a></h2>
<p>After resolving the call to EAX, the address of <strong>sub_0045EAB0</strong> in OllyDbg, checking that function in IDA, there is a call to <strong>operator delete</strong>.</p>
<p>
  <figure>
    <img src="/nday/zdi_17_836/root_cause_analysis/uaf/sub_0045EAB0_function.jpg#center" alt="sub_0045EAB0 function in IDA">
    <figcaption style='text-align: center'>sub_0045EAB0 function in IDA</figcaption>
  </figure>
</p>
<p>Comparing the code decompiled by IDA and what was presented by OllyDbg, <strong>delete</strong> and free are equivalent functions as described <a href="https://www.geeksforgeeks.org/new-vs-malloc-and-free-vs-delete-in-c/">here</a>.</p>
<p>
  <img src="/nday/zdi_17_836/root_cause_analysis/#center" alt="">


  <img src="/nday/zdi_17_836/root_cause_analysis/#center" alt="">
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://0xnibbles.github.io/tags/nday/">nday</a></li>
      <li><a href="https://0xnibbles.github.io/tags/zdi-17-836/">ZDI-17-836</a></li>
      <li><a href="https://0xnibbles.github.io/tags/cve-2017-12561/">CVE-2017-12561</a></li>
      <li><a href="https://0xnibbles.github.io/tags/uaf/">UAF</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://0xnibbles.github.io/posts/slae64/slae_64_assignment_7/">
    <span class="title">Next »</span>
    <br>
    <span>SLAE64 Assignment 7 - Custom Crypter</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share ZDI-17-836 - dbman Opcode 10012 Use-After-Free Remote Code Execution on twitter"
        href="https://twitter.com/intent/tweet/?text=ZDI-17-836%20-%20dbman%20Opcode%2010012%20Use-After-Free%20Remote%20Code%20Execution&amp;url=https%3a%2f%2f0xnibbles.github.io%2fposts%2fnday%2fzdi-17-836%2f&amp;hashtags=nday%2cZDI-17-836%2cCVE-2017-12561%2cUAF">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share ZDI-17-836 - dbman Opcode 10012 Use-After-Free Remote Code Execution on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2f0xnibbles.github.io%2fposts%2fnday%2fzdi-17-836%2f&amp;title=ZDI-17-836%20-%20dbman%20Opcode%2010012%20Use-After-Free%20Remote%20Code%20Execution&amp;summary=ZDI-17-836%20-%20dbman%20Opcode%2010012%20Use-After-Free%20Remote%20Code%20Execution&amp;source=https%3a%2f%2f0xnibbles.github.io%2fposts%2fnday%2fzdi-17-836%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
</div>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://0xnibbles.github.io/">nibbles</a></span>
   
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
